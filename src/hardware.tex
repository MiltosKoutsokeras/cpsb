\chapter{Hardware: CPS1}

The project that would later be dubbed by the press "superchip"\cite{tgm198906} started between 1985 and 1986. It was a massive investment that would require two years and five millions dollars. The result of this endeavor would be to dictate the life or death of Capcom.

\begin{q}{Yoshiki Okamoto, Producer (Capcom)\cite{gamest38}}
The CP System is an extremely important business strategy to Capcom: we’ve gambled everything on it.
\end{q}

The CPS-1 was expected to reduce production cost, lower selling price, streamline development, increase capabilities and stop piracy. 

Cost reduction would be achieved by mimicking home consoles and standardizing the platform. Instead of re-designing hardware boards for each games, the hardware would be a constant with the cabinet differentiated only by the software running on it.

Price lowering would allow arcades operators to renew their games more often. This objective would be reached by designing a platform where new games board containing mostly ROMs could be purchased separately from the processor board therefore facilitating upgrades.

To improve the development toolchain, the CPS-1 was designed to work hand-in-hand with Sharp series of X68000 workstations which featured the same CPUs and programming models.

More importantly, games would had to catch customer eyes and not pale in comparison to competition. The goal was to design a machine with graphic capabilities an order of magnitude above others and generate visuals like players had never seen before.

Most importantly was the problem of piracy. In a country like Mexico it was estimated that 200,000 bootlegs were in circulation\cite{sf2_oral_history} despite Capcom recording zero sales in that territory. Multiple concurrent copy-protection mechanisms were to be implemented.


\section{JAMMA}
Both a blessing and a curse, arcade operators owned  standardized cabinets. They would welcome any motherboard as long as Capcom made it compatible with the ubiquitous Japan Amusement Machine and Marketing Association (JAMMA) connector. 

A JAMMA port has everything a game needs to operate. Its 28 pins on each sides provide inputs (four-direction joystick and three buttons per player, two coin sensors, start button, and service button), outputs (mono speakers lines and CRT screen controls), and even power supply.

 \begin{figure}[H]
\draw{jamma_t}
\caption*{JAMMA parts side pins}
\end{figure}

 \begin{figure}[H]
\draw{jamma_b}
\caption*{JAMMA bottom side pins}
\end{figure}

The problem with a standard is that if it improves interoperability, it also hinders innovation. A few pins on the port are not reserved for a specific usage but they could not be used for extra features since a JAMMA port was plugged to a harness which was a tangled mess of wires that operators did not touch after initial cabinet setup.

When Capcom had to retrofit Street Fighter 1 pneumatic buttons, they chose to do it with six buttons per player which was three more than are available in JAMMA. To circumvent the limitation, they designed a parallel input system. Since the three JAMMA buttons were used for punches, the extension was labeled the "kick harness".

\begin{figure}[H]

\begin{tabularx}{\textwidth}{lrX}
  \toprule    
  \textbf{Wire Color } & \textbf{ Pin \#}  & \textbf{Function } \\               
  \toprule   
  Black & 1 & GND \\
  Black & 2 & GND \\
  \toprule   
  Purple & 3 & Player 1 Light Kick \\
  Grey & 4 & Player 1 Medium Kick \\
  White & 5 & Player 1 Heavy Kick \\
  \toprule   
  & 6 & NC \\
  \toprule   
  Orange & 7 & Player 2 Light Kick\\
  Green & 8 & Player 2 Medium Kick\\
  Blue & 9 & Player 2 Heavy Kick\\
  \toprule   
  & 10 & NC \\
  \toprule   
\end{tabularx}
\caption*{Kick harness pinouts}
\end{figure}










  


\section{Physical Architecture}
 The CPS-1 is made of three PCBs stacked on top of each others. The biggest board at the bottom is Board "A". In the middle is the Board "B". On the top is the smaller Board "C". Boards "A" and "B" are connected via four white connectors featuring 2x32-pin each. Similarly, boards "B" and "C" are connected respectively two white 2x20-pin connectors.

Over the years, the system was revised multiple times. What will be discussed in this section are the boards coming  with "Street Fighter 2: The World Warriors", A (88617A-7B), B (90629B), and C (90628-C).

\begin{figure}[H]
\centering
\simg{0.9}{arch_phy.jpg}
\caption*{A full CPS-1 game made of three PCBs}
\end{figure}


\subsection{Board A} 
The board "A" is the platform that never changes between games. It features all but one of the chips in charge of processing data, whether it is game logic, audio, or video.

A summary look at page \pageref{fig:boarda} reveals the powerhouse of the whole system. Even an untrained eye will notice the size of the Application-Specific Integrated Circuit (ASIC) and the shear number of bus lines leading to it. In the center left stands the "CPS-A", in charge of 50\% of the graphic system and its 16MHz oscillator. Just above is 384 KiB of VRAM to store a special kind of framebuffer studied in later pages.

Directly below the CPS-A is the video system and its 8 KiB of SRAM containing the palettes.

The upper right section is the control system with a Motorola 68000, a 10MHz oscillator, 64 KiB of "work" SRAM and 192KiB of GFX SRAM. 

The middle right part is where the audio system lives. It is made of a Zilog-80, a 3.58MHz oscillator, and 2 KiB of "work" SRAM. Also in this area are present the audio chips dedicated to music (YM2151 and YM3012) and sound effects (OKI6295).

Finally, in the bottom part we find all the components taking care of the inputs and outputs leading to the JAMMA connector. Alongside are DIP switches which an arcade operator can use to configure things such as game difficulty or how many credits a coin grants.

There are many chips on these three boards but it would be a mistake to conclude that combining many processors inevitably leads to better performance. That would be ignoring issues such as bus congestion, bus size difference, bus timings or even processor endianness. 

To design an effective multi-CPUs system able to avoid both instructions and data starvation is in fact far from trivial.


\
  \simg{0.94}{88617A.png}
\label{fig:boarda}


  \sdraw{0.94}{88617A}





\subsection{Board B}
   The board B is where the ROMs chip containing all the assets and instructions specific to a game are attached via DIP sockets. ROMs are grouped depending on the system they belong to. 

   There is a capacity of 3x8 = 24 chips dedicated to storing GFX (1-8, 10-17, and 20-27) for a total of 12 MiB (although no game ever used it all).

   One socket (9) with 64KiB capacity stores both the Zilog 80 instructions and the music assets.

 
\vfill
\begin{figure}[H]
  \nbimg{90629B-3.jpg}
  \caption*{Empty board B}
  \end{figure}

    Two sockets (18-19) accounting for 256 KiB store PCM samples and are directly connected to the OKI chip.

   Finally eight ROMs holding 1 MiB are dedicated to hosting 68k instructions. Note that even though they are related to graphics, palettes belong to the video system and are stored along 68000 instructions.

In the upper right, we find four CR connectors leading to board "B". Soldered on the bottom are also 4 white connectors leading to board "A". 


   Notice that despite different data width requirements, all four storage systems are build with only two types of ROM chips.

\vfill
\begin{figure}[H]
  \nbimg{90629B.jpg}
  \caption*{Board B with Street Fighter 2 ROMs}
  \end{figure}

% We will study in the storage subsystem how all these ROMs can be used to build 8-bit, 16-bit, or even 32-bit data buses.


\nbdraw{90629B}

Notice, on the board "B" above, how the PAL \icode{STF29} controls the GFX ROM and the PAL \icode{IOB2} controls the m68k ROM.
% \begin{figure}[H]
% \centering
% \nbdraw{90629B}
% \caption*{STF29 }
% \end{figure}



\subsection{Board C}
Board "C" hosts the "CPS-B" ASICs video chip. It is the beefy pixel generator directly connected to both the video system and the GFX ROMs.

Capcom concentrated its anti-piracy measures in that chips and as a result revised the board "C" many more times than the two others. This is discussed deeper in the copy-protection section of this chapter.

% released many revision of its hardware in order to remain one step ahead of pirates. Since it concentrated most of its countermeasures on the CPS-B, it made sense to have the chip be on its own board.

\begin{minipage}[t]{0.49\linewidth}
  \simg{1.0}{90628-C-2.jpg}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.49\linewidth}
  \nbdraw{90628-C}
\end{minipage}

\subsection{PALs}
The black chips are PALs (Programmable Array Logic) which are crucial to the creation of a memory map. They define boolean (\&, \textbar, !) logic between input and output lines to reduce complexity. More importantly they allow tuning the design between games without changing the PCB.

\sdraw{0.45}{PAL16L8A}

 Often located near the memory chips group they affect, they are renamed between revision. e.g: Street Fighter II's \icode{STF29} which organizes GFX ROM is named \icode{S224B} in Final Fight or \icode{DM620} in Ghouls'n Ghosts.



\section{Logical Architecture}
The multiple processors are organized hierarchically. Commands issued at the top are carried out to sub-systems via a chain of reports. There is a strong layering where top systems are unable to access sub-systems resources (control has no access to VRAM and audio ROM).

\nbdraw{arch_hierarchy}

The control system and its 68000 is in charge of coordinating inputs (joystick, buttons, coin) and outputs. It can communicate with both the gfx and audio system.

The audio system runs almost totally in isolation. It is connected to control only via two 8-bit latches which the Z-80 actively polls to retrieve commands related to music and sound effects. Notice how these latches bridge different data bus width since control has 16 data lines while the audio system's uses 8 data lines.

The graphic system needs more communications and exposes not only its CPS-A and CPS-B registers but also GFX RAM where the screen layout is described. The 68000 and the CPS-A use the same bus to access the GFXRAM so the demarcation is not as clean as with the audio system which result in a bit of bus contention.  

The video system produces a stream of palette addresses (pen). Combined with the palette SRAM (ink) and the DAC, it outputs a signal towards JAMMA.
It is heavy duty to keep up with the 59.64Hz refresh rate.

\begin{figure}[H]
\nbdraw{arch}
  \caption*{CPS-1 logical architecture with data lines}
  \label{cps1_arch}
  \end{figure}


% \section{Storage system}
% The game code and assets are all stored on ROMs on the Board B. All storage subsystem whether they are meant to the 8-bit Z-80, the 16-bit 68000, or the 64-bit PPUs are build with the same XXXX component.

\section{Control system}
At the core of the control system we find the immensely popular Motorola model 68000.

\subsection{Motorola 68000}

 Released in 1979, and clocked at 10 MHz (later upgraded to 12 MHz), the MC68000 was not a particularly powerful chip by the late 80' standards with its two stage pipeline\cite{M68000fv} (prefetch, exec) and no cache. Its 1.7 MIPS place it on par with an Intel 286 10MHz. By 1989 it was already two generations old behind the 68020 (1984) and the 68030 (1987).

Yet the Atari ST, Amiga, Sega's System 16, Genesis, and CD, NeXT Computer, Apple Macintosh, Sharp X68000, and SNK's Neo-Geo all used it as their backbone. The 68,000 transistors CPU was IBM's first choice for it PC but production issues allowed the Intel's 8088 to prevail\cite{ieee20170630}. 

Performance is not what made the 68000 rein as the prime hardware designer choice. The reason this CPU was so successful is because it was a great team player.

While most machines used 16-bit address system, its 24-bit address space allowed the 68000 16 MiB of RAM which was considered humongous at the time. This was a considerable advantage when it came to map peripherals. There is so much address space that, had they wished so, Capcom engineers could have allowed the 68000 to see all RAM and all ROM of all systems on the CPS-1.

Moreover, where other CPUs used small address registers resulting in the infamous segmented addressing, Motorola engineers gave their CPU 32-bit data and address registers. This not only allowed elegant flat addressing, it also gave coders a free meal where a program compiled once would get access to more than 16MiB RAM on later products. 


\sdraw{0.8}{68000}



The CPU is brought to life via clock (\icode{CLK}), +5V (\icode{VCC}), and Ground (\icode{VSS}).

The bus is made of (\icode{D0-D15}) for data, (\icode{A1-A23]}) for addresses, and Address ACK (\icode{AS}), Read/Write (\icode{R/W}), \icode{UDS}, \icode{LDS}, and Data ACK \icode{DTACK} for control.


Arbitration to allow peripherals to master the bus is done with Bus Request (\icode{BR}),  Bug Grant (\icode{BG}) and Bus Grant ACK (\icode{GBA-K}).

The interrupt system is made of \icode{IPL0}, \icode{IPL1}, \icode{IPL2}, and \icode{VPA} while System control is done via Error (\icode{BERR}), Reset (\icode{RST}), and Halt (\icode{HALT}).

Processor status is given by \icode{FC0}, \icode{FC1}, \icode{FC2} and Peripheral control is done via sync (\icode{E}) and valid sig (\icode{VMA}).


\begin{trivia}
 The 68000 has no \icode{A0} pin. Accessing unaligned memory will make the CPU crash. Instead, developers must use \icode{UDS} and \icode{LDS} to indicate which byte or bytes to access.
\end{trivia}

\begin{trivia}
 The 68000 has 32-bit address registers but used only 24-bit addresses. These 8 bits of "unused" pointers were used by system engineers to mark address as "locked" or "purgeable", making their programs forward-incompatible. 
\end{trivia}

Perhaps the best testament to the quality of the 68000 design is that, as of 2021, 42 years after its release, Motorola's CPU is still in production.


\subsection{Motorola 68000 "work" RAM}
With a 16-bit data bus processor it would have been fair to expect a memory system built with 16-bit RAM chips. However these were expensive and a closer look reveals a bunch of \icode{65256BLSP-10} offering fast access time (100ns SRAM) and 32 KiB capacity but only 8 data lines.

\sdraw{0.6}{65256BLSP-10}
\pagebreak

Using cheaper of-the-shelves 8-bit RAM chips instead of 16-bit RAM chips helped to drive down the cost. Moreover, these are not hard to combine into a 16-bit RAM system via two-way interleave.

\begin{figure}[H]
\nbdraw{64k_ram}
\caption*{32 Ki x 16-bit RAM system with two 32 KiB x 8-bit chips}
\end{figure}

The two chips are not aware of each others. They are connected to the same 15 address lines and the same control lines for write (\icode{WE}) and read (\icode{OE}). However, they are connected to different lines of the data bus. 

% Notice how the 14 address lines of the RAM chips are connected to the bus lines [11-23], effectively placing the RAM at address \icode{0xFF0000}-\icode{0xFFFFFF}. Carefully selecting lines is one of the three building block of designing a memory map. The two others are explained in the next section.

 \begin{trivia}
 64 KiB of RAM seems like a lot but was not always enough. Some tiles found themselves with not enough RAM and too much GFXRAM. Street Fighter 2 Champion Edition programmers resolved to generating and executing instructions from the GFXRAM\cite{mame_driver}!
 \end{trivia}

Notice how the address lines of the SRAM chips are directly connected to the 68000 address bus. There is no mechanism to prevent these two chips to respond to all requests made on \icode{[0x**0000-0x**7FFF]}. This is an over-simplification to introduce complexity progressively. We will see next how chips are organized to not overlap with each others.









\subsection{Motorola 68000 Program ROM}

% \begin{trivia}
% Notice how important alignment becomes with such a memory system. Reading 2-byte aligned addresses yields the correct result but to put unaligned memory on the 16-bit data bus is not possible. An unaligned read requires two 16-bit aligned read, two shifts and one OR. It is a very expensive operation.
% \end{trivia}

The 68000 instructions are provided by eight \icode{27C010} which are 128 Ki x 8-bit chips. They work like the \icode{65256BLSP-10} except that they have sixteen address lines instead of fifteen (and therefore higher capacity).

Like the RAM, ROM chips are combined two-ways to provide 16-bit data. What is peculiar is how the four pairs are arranged to build a memory system with a larger capacity.


\begin{figure}[H]
\nbdraw{128k_ram}
\caption*{Two first pairs. 4 x (128 Ki x 8-bit) making a 256Ki x 16-bit system}
\end{figure}

To place one pair after another in memory space, the \icode{CE} (Chip Enabled, sometimes labeled \icode{CS} for "Chip Selected") pin is leveraged. Asserting it let a chip respond to address request while de-asserting it keeps it dormant. All CEs on all chips on all boards are controlled via PALs.

Here, the first four out PAL pins must be programmed as follows.

\begin{code}
0 = !(A16  | A17 | A18 | A19 | A20 | A21 | A22 | A23)  
1 = !(A16  | A17 | A18 | A19 | A20 | A21 | A22 | A23)  
2 = A16 & ! (A17 | A18 | A19 | A20 | A21 | A22 | A23)  
3 = A16 & ! (A17 | A18 | A19 | A20 | A21 | A22 | A23)  
\end{code}

The first pair of chips is mapped to addresses \icode{0x000000} while the second pair is mapped to \icode{0x40000}. With the same logic, two more pairs of \icode{27C010} are mapped at \icode{0x80000} and \icode{0xc0000} for a total of 1 MiB ROM.


\subsection{Chip Enabled / Chip Select}

The \icode{CE} / \icode{CS} line is absolutely crucial to build a memory map. They are present in every chips studied in this book (except CPUs).

\subsection{68000 Memory Map}

All chips are mapped at a static address in memory space. A table give a clear picture of how Control masterminds everything.

% \begin{figure}[H]
% {
\begin{tabularx}{\textwidth}{rrrX}
% \toprule    
  \textbf{Start } & \textbf{End  } & \textbf{Size } & \textbf{Function } \\               
  \toprule    
  \texttt{0x000000} & \texttt{0x3FFFFF} & 3 MiB & ROM \\
  \toprule    
  \texttt{0x800000} & \texttt{0x800007} & 8 B & JAMMA players inputs \\
  \texttt{0x800018} & \texttt{0x80001F} & 8 B & JAMMA Dip Switches \\
  \texttt{0x800030} & \texttt{0x800037} & 8 B & JAMMA Coin sensors \\
  \texttt{0x800176} & \texttt{0x800177} & 1 B & Kick harness \\
\toprule    
  \texttt{0x800100} & \texttt{0x80013f} & 64 B & CPS-A registers\\
  \texttt{0x800140} & \texttt{0x80017f} & 64 B & CPS-B registers\\
\toprule    
  \texttt{0x800180} & \texttt{0x800187} & 8 B & Sound commands (latch 1)\\
  \texttt{0x800188} & \texttt{0x80018F} & 8 B & Sound commands (latch 2)\\
  \toprule    
  \texttt{0x900000} & \texttt{0x92FFFF} & 196 KiB & GFXRAM\\
  \texttt{0xFF0000} & \texttt{0xFFFFFF} & 64 KiB & RAM \\
  % \toprule    
\end{tabularx}%
% }\caption*{Control system memory map.}
% \end{figure}

Upon startup, the 68000 bootstrap and starts retrieving instructions from ROM. For store/load instructions and to maintain its stack, it uses "Work RAM". Game configuration is retrieved from DIP switches. The game start where an infinite loop polls coins sensors and players inputs to generate video and audio outputs in response. For the video, the 68000 describes an image to be displayed via the GFXRAM then instructs the graphic ASICS of where to find that data. For the audio, the 68000 issues simple commands to the Z-80 via two 1 byte latches using a protocol detailed later.
  











\pagebreak
\section{Audio system}
The audio system runs in isolation from everything else. It has its own bus, its own RAM, its own ROM systems, and its own oscillators. Its only opening to the outside world are two latches to receive commands from the control system and two JAMMA pins where to output sound.

Its internal architecture looks like a repeat of the control system where several components are under the control of a single coordinator. Only this time the CPU in charge is the Zilog-80 running at 3.58 MHz.

\subsection{Z-80}
Released in July 1976 by Zilog, the Z-80 was, alike the M68000, an immensely successful CPU. 

It was one of the most widely used processors in home computers notably featured in the Sinclair ZX Spectrum and the Amstrad CPC. It was seen almost everywhere until the mid-80s, finding its way in military applications, musical equipment (Roland Jupiter-8), and coin operated arcade games including Pac-Man. 

As an 8-bit era processor, the Z-80 features 8-bit data registers, 8-bit data bus, 16-bit address registers, and 16-bit address bus. In terms of processing power, it had become a particularly weak CPU by late 80s standards with 0.45 MIPS making it three times slower than the MC68000 in the control system. 

The reason it was selected by Capcom (and by SNK for its Neo Geo) was not for its processing capacity but because it was an inexpensive CPU, well-known by programmers which would also integrate well with 8-bit interface chips such as ROM chips, RAM chips, and audio chips such as the MSM6295 and the YM2151 (both also 8-bit).

\sdraw{0.75}{z-80}





The chip comes to life thanks to its clock (\icode{/CLK}), power \icode{/V5+}, and ground \icode{/GND} pins.

The bus lines are multiplexed with \icode{/D0-/D15} for addresses and \icode{/D0-/D7} for data. For control, \icode{/RD} indicates read while \icode{/WR} indicates a write operation. \icode{/WAIT} is used to add waitstates. 

Although it is capable of relinquishing control of the bus via \icode{/BUSRQ} Request bus mastering,\icode{/BUSACK}, Acknowledge, \icode{/MREQ} Request to use bus, IO bus \icode{IORQ}, the Z-80 completely own its bus and never shares it. 

In fact, the \icode{BUSRQ} and \icode{BUSAK} pins are not even connected.  Because it is isolated via latches, the Z-80's bus never suffers contention.


\icode{/INT} Interrupt line, \icode{/NMI} Non Maskable Interrupt, \icode{/RESET} Restart CPU, \icode{/HALT} Waiting for interrupt, \icode{/M1} Fetching next instruction.

\begin{trivia}
 The Z-80 has a built-in timer to easily include DRAM on a motherboard. The \icode{/RFSH} pin (ReFreSH signal) tics at regular interval for the memory refresh.
\end{trivia}

\subsection{Z-80 "Work RAM" and ROM}
Little RAM is need by the Z-80 since it forwards request from the latches to the OKY6295 and feeds registers  of the YM2151 for music. The RAM is is a single 2Ki x 8-bit \icode{CXK5816SP-15L}. The ROM is a single 64Ki x 8-bit \icode{27C512} which is larger to store musics on top of Z-80 instructions. 

% Sound commands are forwarded as ID/channel/volume to the OKI6295. 

% Music commands are a bit more involved since when a music ID is received the Z-80 needs to constantly retrieve notes from its ROM and feed them to the YM2151.

These chips work alike those we have already studies with pins such as power, ground, addresses, data, control, and of course the crucial \icode{CE}. What is peculiar is that the Z-80 uses 16-bit address registers to address 65,536 bytes so there is not enough address space for all registers, ROM, and RAM totaling 96 KiB.

The solution Capcom engineers used was to map only the portion of the ROM that contain instructions (32KiB) statically and to use a banking system to provide a 16 KiB "view" into the remaining 32KiB of the ROM where the music assets are stored. This is accomplished with a PAL (\icode{SOU1}) and we will see in the programming section how much of a pain it was for to developers.



\subsubsection{Memory Map}

\begin{figure}[H]
{
\begin{tabularx}{\textwidth}{rrrX}
\toprule    
  \textbf{Start } & \textbf{End  } & \textbf{Size } & \textbf{Function } \\               
  \toprule    
  \texttt{0x0000} & \texttt{0x7FFF} & 32 KiB & ROM (32 KiB out of 64 KiB)\\
  \texttt{0x8000} & \texttt{0xBFFF} & 16 KiB & Bank-switched view of rest of ROM\\
  \toprule    
  \texttt{0xD000} & \texttt{0xD7FF} & 2 KiB & RAM \\
\toprule    
  \texttt{0xF000} & \texttt{0xF001} & 2 B & YM2151 registers\\
  \texttt{0xF002} & \texttt{0xF002} & 1 B & OKI OKI6295 registers\\
  \texttt{0xF004} & \texttt{0xF004} & 1 B & Bank Switch control (\icode{SOU1})\\
  \texttt{0xF006} & \texttt{0xF006} & 1 B & OKI MSM6295 H / L mode\\
  \toprule    
  \texttt{0xF008} & \texttt{0xF008} & 1 B & Sound commands (latch 1)\\
  \texttt{0xF00A} & \texttt{0xF00A} & 1 B& Sound commands (latch 2)\\
  \toprule    
\end{tabularx}%
}\caption*{Audio memory map.}
\end{figure}

\begin{trivia}
Notice the awful bank switch control byte a programmer must juggle with to access data located beyond \icode{0x8000}. This memory map should leave no doubt with regards to why the 68000 and its 24-bit address space were the top choice among hardware designers. 
\end{trivia}
% CXK5816SP-15L is only 2 KiB RAM

\subsection{YM2151}
Selecting the music chip was not a matter of shopping vendors but rather to pick one from Yamaha. Thanks to the licensing of Frequency Modulation (FM) patents from Stanford in 1975, the Japanese founder ruled the world of electronic music.

Three architectures stoud out in the early 90s. Among the OPL2 (YM3812) and the OPN2 (YM2612), the OPM (OPerator type M) YM2151 was selected for its versatility. 

The YM2151 is able to play 8 channels (a.k.a voices) of audio without requiring any additional ROM or RAM. Each channel consists of four operators (a.k.a slots) which can be setup to produce either percussion or instruments sounds. The principle is to use simple wave forms to module each other in a Modulator/Carrier pair resulting in complex waveforms\cite{fmProgramming}.

\img{waveforms.png}

Other parameters can be applied to the output sound such as Attack/Decay/Sustain/Release rate. The huge advantage is the small amount of data required to store a melody since only notes of each instruments are needed. The whole Sagat stage music (XmnXXs) takes less than one "Tiger Uppercut" ADPCM sample (Xs).

Looking at the chip, we see previously discussed pins such as \icode{+5V}, \icode{GND}, and \icode{CS}. The \icode{CLK} is connected to the same oscillator as the Z-80 for a frequency of 3.58MHz. The \icode{D0-D7} address/data pins (multiplexed via \icode{A0}) fit exactly the Z80's 8-bit data bus with read (\icode{RD}) and write (\icode{WR}) control.

The important pin is the \icode{INT} which allows the YM2151 to generate interrupt based on two internal counters. These will be crucial in the programming chapter.

\sdraw{0.5}{YM2151}

The only drawback of this chip is that is features no DAC (Digital to Analog Converter). It generates a signal on the Serial Output (\icode{SO}). That is a problem since JAMMA expect an analog signal.

\subsection{YM3012}
The YM3012 input is directly connected to the YM2151 output. It is the tailor made DAC which, as it name indicates, converts the digital stream from the YM2151 to an analog signal that later mixed with the analog signal of the OKI6295.

\subsection{MSM6295}
For audio sample playback, Capcom spared no expenses and selected a chip capable of 12-bit hardware ADPCM audio decompression over four channels, the MSM6295 (a.k.a OKI6295). 
% capable chips by the past with the MSM5205 by OKI Semiconductor. For the CPS-1  they went with a steroids version,

Despite running at only 1MHz the MSM6295 is a god sent to a game board designer. It does not need instructions since its function is fully hard-coded. Its address (\icode{A0-A15}) and data lines (\icode{D0-D7}) are directly connected to its own 256 KiB ROM, on a local bus where assets are stored. These make it a fully enclosed digitized sound system only communicated via its input lines (\icode{I0-I7}), perfect for the Z-80 data bus.

To work, the OKI only needs a sample ID [1-127], a channel [1-4], and a volume. Via a lookup table in ROM the sample offset is retrieved and playback starts with an analog signal generated on \icode{DA0}. 

\sdraw{0.75}{MSM6295}

Up to four channels can playback samples simultaneously. During a game, some channels are reserved for percussion instruments for the stage tune, other channels are kept free for game sound effects.

 ADPCM lossy compression is able to divides space consumption by three by converting 12-bit PCM samples into 4-bit nibbles. 


\subsubsection{Making choices}
If the choice of the Yamaha music chips left little ambiguity to the hardware designer, the MSM6295 was a different story.

First off all, the sampling rate expected in ROM is directly correlated to the clock provided to the MSM6295. Second of all, the OKI can operate in two modes, a high quality (H) where the divisor is 132, and a low quality (L) where the divisor is 165.

Clockable between [1MHz-5MHz] with two modes, the goals was to maximize quality while minimizing required storage. The table shows that the best quality (37kHz) only allowed to store 13 seconds of samples while the worse (6060Hz) gave 69 seconds.
\begin{figure}[H]
{
\setlength\cmidrulewidth{\heavyrulewidth} % Make cmidrule = 

\begin{tabularx}{\textwidth}{Ycccc}

  & \multicolumn{2}{c}{H} &  \multicolumn{2}{c}{L} \\
  \cmidrule(lr){2-3}
  \cmidrule(lr){4-5}
  \textbf{MHz } & \textbf{Samping Rate (Hz)} & \textbf{Time (s)} & \textbf{Samping Rate (Hz)} & \textbf{Time (s)}\\               
  \toprule    
  \texttt{1} & 7575 & 69 & 6060 & 86\\
  \texttt{2} & 15151 & 34 & 12121 & 43\\  
  \texttt{3} & 22727 & 23 & 18181 & 28\\
  \texttt{4} & 30303 & 17 & 24242 & 21\\
  \texttt{5} & 37878 & 13 & 30303& 17\\
  \toprule    
\end{tabularx}%
}\caption*{MSM6295 operating modes (with ROM = 256 KiB).}
\end{figure}

In the end, Capcon connected the OKI to the GFX crystal (16MHz) and divided frequency by 16 to run at 1MHz. Along with a SS pin set to H, the system uses 7,575Hz sampling rate.




\subsection{The beauty of ADPCM compression} %\label{adpcm_decompression_label}
We cannot close the OKI section without taking a close look at how ADPCM works and how beautiful it is.

Let's study first what is compressed. Whether it is recorded or played, PCM (Pulse-code modulation) is a stream of value directly representing the position of a device diaphragm.

\nbdraw{speaker}

The higher the sampling rate, the more often the diaphragm position can be adjusted. The higher the bit depth, the more accurately the current can position the diaphragm. With two PCM streams of values, stereo is achieved.

This is system where sound quality increases linearly with it data rate. Land-line phones typically use 8000Hz sampling rate with 8-bit depth mono consuming 8,000 bytes per second while a CD uses 16-bit samples at 44100Hz in stereo taking its data usage to 176,400 bytes per second.
\pagebreak

ADPCM is able to take 12-bit sample and store then as 4-bit samples by remembering the value of the last sample and encoding a delta to apply on it. 

The delta uses a system close to floating-point windows which is accurate for small amount but much coarser when values increase. 

A nibble is made of 4 bits. The first one indicates the sign of the delta (+/-). The three other give a "magnitude". The magnitude depends on the "step size" of the ADPCM decompressor.

\sdraw{0.3}{adpcm_nibble}

In its initial state, the step size is equal to 16 which means bit three is +/-16, bit two +/-8 and bit one +/-4. In this state, the delta to be applied can vary from 0 (\icode{b000}) to 28 (\icode{b111}). 

The decompressor constantly monitor how much of the step size was used. The step size is adjusted after each sample via a  predetermined transition table.

\lstinputlisting[language=C]{src/code/adpcm_transition.c}


ADPCM is aggressive in increasing its step size (\icode{2, 4, 6, 8} when high magnitude are used) and conservative in lowering it (\icode{-1, -1, -1, -1}). Note that \icode{stepSizeIndex} must be clamped to 0-48.










\section{Video system}
The goal of the video system is to drive signals for the CRT to generate images. Even though it is connected to the JAMMA port, there is no abstraction layer or custom protocol. The four red, green, blue, and sync JAMMA output pins are connected directly into the CRT inputs.

\nbdraw{rgb_wires}

There are four wires but in fact five signals are transmitted. Each red, green, and blue signal have their own wire but the sync wire carries two signals multiplexed as the horizontal sync pulse and vertical sync pulse. Because it composed of two signals, it is called called CSYNC (Composite SYNC). 
These five signals are everything a CRT needs to work. 

\subsection{CRT 101}

Because the timing of operations is propagated deep into the GFX system, it is important to understand how a CTR works.

At its core, a Cathode-Ray Tube (CRT) is a line drawing machine. It draws horizontal lines one after an other, from left to right and top to bottom. While is scans a line, three analog signals (one for each RGB colors) indicates the quantity of electrons to shot from three guns. The higher the signal, the more electrons are shot and the more vivid the color.


On the way toward the panel, electrons are filtered through a shadow mask to make sure they hit the proper type of colored phosphor receptacles which are grouped by three in RGB "slots". The electron beam-slot is not a one to one relationship, as we will see the beam can be larger or smaller than a slot.

% \begin{trivia}
% Triads in CRT, Slots in TV.

% Also mention Sony Positron.

% \end{trivia}


\begin{figure}[H]
\img{shadow_mask.png}
\caption*{Electon gun, mask, and slots}
\end{figure}

Slots are not aligned horizontally. When the gun shots electrons it doesn't really know on which slots they will land. They can hit all in one slot, or two halves of two slots or anything depending on slot density and beam dispersion. 

The only guarantees are that the electron from a canon color always land in a phosphor receptacle of the same color and the electron beam height is constant on a line.

\begin{figure}[H]
\draw{triad_slots}
\caption*{A scanline of electron hits whereever.}
\end{figure}

Smaller slots can render the horizontal analog signals with better fidelity.


\draw{triad_slots_hd}



 With these duality of lines and signals, a CRT is both a numeric and an analog system. The number of scanlines is finite (i.e: there is a set number of these elements) but there is no horizontal number of "dots", "points", or "pixels" since the three color intensity signals are analog.


\subsection{Syncing}
The lines are drawn one after an other via the RGB signals but to display a proper image there is a need for a control signal so the CRT can synchronize and know which line is at the top of the screen and when a line starts. Without it, the image would be distorted. 


\img{desync.jpg}

The previous figure depicts a desynced TV. The lines are correct but they are not located where they should be.

The horizontal syncing is done via HSYNC signal and the vertical syncing is done via VSYNC signal. These signals are detected by the CRT to position the gun properly with regards to the origins sets in the upper left.

VSYNC tells the CRT that it should reset the gun's vertical position to 0 which is the top of the screen. This motion from bottom to top is called vertical retrace. During the retrace the gun keeps on shooting electrons but, as we will see later, is requested to use color black (no electrons). This "blanking" of the RGB lines happens a little bit before and after VSYNC. The total time not drawing anything is called VBLANK.

HSYNC tells the CRT that a line has been drawn and the gun horizontal position should be reset to the left of the screen. This motion is called horizontal retrace. Alike the VBLANK, there is a HBLANK timespan.

By detecting VSYNC and HSYNC, the CRT can "synchronize" the signal with the guns and draw the image where it belongs.


\begin{trivia} The CRT is purely a signal consumer. It never sends anything back on these wires. It is a common misconception that the CRT emits VSYNC. In fact, all signals are generated by the video system.
\end{trivia}


\subsection{Fields}

The process of drawing scanlines over the screen, also called "Raster scan", is flawed as described. If the gun draws a line and upon HSYNC goes back to the left, it would be drawing the same upper left line over and over again. 

It is barely noticeable but scanlines are not drawn straight. There is a slight downward slope. This way, when HSYNC is received and horizontally position is reset, the next line is drawn below the previous.



\nbdraw{p_scan}

As long as VSYNC is issued at the same time as a HSYNC, the CRT lines are always on the same location on the screen.

Let's look at what happen if VSYNC happens in the middle of the last line being draw.

\nbdraw{i_scan}

Because only half a line was drawn at the bottom, it only progressed down half a space vertically. As a result, the next frame will be interlaced with the previous. This is a technique used by TV broadcast such as NTSC in USA and Japan. A signal transmit frames at 30Hz, each contains two "fields" to be drawn interlaced one after an others.

While interlaced is acceptable for TV images, it is not for gaming since the artifacts are disturbingly visible on moving text and sprites. 

The solution to this problem is to only use one field and never display anything on the other one. Doing this means designing a video system where VSYNC is always issued along with a HSYNC. The drawback is that since CRTs were build to display interleaved images, they provision space between lines. 

Since this space is not used for another field, the resulting effect is black horizontal strips on the screen. Note that the problem is compensated by line bleeding so the black lines are not as big as visible lines.

\img{sf2_4_3_interlaced.png}

HSYNC, VSYNC, and color does not seem like a lot but they allow hardware designers a great deal of freedom. 

Besides interlacing that had to be discarded, there are also decisions to make about how many lines to draw, how much horizontal resolution to use, and at what frequency should the screen be refreshed.





\subsection{Making choices (again)}
 The main figure to consider when designing a video system is how fast the display can draw lines. In the late 80s, standard CRTs horizontal scan rate was 15.7 kHz which means they could draw 15,720 lines per second.





\subsubsection{Vertical scan rate}
Because these CRTs were made to display NTSC signals, they were guaranteed to sync with VSYNC in the vicinity of 60Hz. Combining this figure with the horizontal scan rate gave 15,720 / 60 = 262 lines per image.


\subsubsection{Picking a vertical resolution}
Out of these 262 lines, not all of them can be used. The issue is that when the VSYNC is emitted, the electron gun resets vertically in a nearly instantaneous fashion. As a result, the electron beam wobbles for a bit afterward which results in visible artifacts. To avoid visual disturbance, the trick is to simply draw black on these disturbed lines. 

Besides mechanical issues, hardware designers had to account for various CRT quality. Some screen drew lines outside of their visible bounds, a phenomenon known as over-scan. To solve this problem, the number of lines for colors had to further be reduced to ensure a "safe area" would always been drawn regardless of the CRT overscan properties.

% Considering these two constraints, Capcom settled on discarding 38 lines, keeping 224 active lines


\subsubsection{Picking an horizontal resolution}
Similar constraints came into consideration when choosing an horizontal resolution. Like VSYNC, HSYNC induces wobbling which must be hidden, reducing the length of a line. Similarly, horizontal overscan had to be factored in.

Moreover, even though the color signal is analog, there is still a maximum limit due to bandwidth. CRTs of the era usually were able to keep up with 512 color changes per line.

Finally there was a question of aspect ratio. Since the vertical number of line had been chosen by this point, the horizontal number of points had to be picked to ideally match the 4:3 aspect ratio of the monitor.


\subsection{CPS1 choices}
Besides the vertical and horizontal "rules" we just reviewed, Capcom engineers had additional constraints.

First of all, because the GFX system is digital, they had to pick dimension that could be represented as integer. There was also the graphic system which required both axis to be multiple of 8 (for the tilemaps we will study in the next section).

To check all the boxes, Capcom had the choice between only two resolutions, 288x216 and 320x240. Ultimately they picked neither. They gave 38 lines to VBLANK and kept 224 active lines\cite{petitCRT}. Horizontally, they left 128 elements to HBLANK and kept 384 active ones.  

Going for 384x224 was an interesting decision from an aspect-ratio standing point. Other manufacturers such as SNK had also dropped 4:3 with their Neo-Geo using 320×224 but the resulting aspect ratio of 10:7 was close to 4:3. With its 12:7, the CPS-1 drew many more dots horizontally and the image appeared vertically compressed. 



% \begin{trivia}12:7 is to closed to 16:9 that, years later, people new to emulation actually wondered if Capcom actually intended games to be played in 16:9 instead of 4:3!
% \end{trivia}

The result was that the CPS-1 did not have square pixels which was a huge problem for artists.  

\begin{q}{Akiman\cite{akiman}}
When I was working on Forgotten Worlds, I noticed the problem of aspect ratio. "The pixels are not square!" I told my boss.

"Impossible, I ordered them to be square!" he replied and called hardware on the spot.

"The pixels are square!" he replied. 

Later I protested again to which my boss replied it was a calculation error.
\end{q}


\begin{trivia}
The designers of R-Type in 1987 played on CRT tolerance in order to craft a video system with increased horizontal resolution. 

They chose the VSYNC to pulse at 55Hz. This gave them extra time between frames so they had to sacrifice fewer lines to VBLANK. They reinvested this saving into more vertical lines to reach 256. As we have seen before, increasing horizontal resolution is just about improving the analog signal. This is what the people at Irem did to push it to 384. In the end, the game enjoyed a higher than competitors resolution of 384x256 at the cost of a 5Hz refresh penalty.
\end{trivia}



\subsection{Colors}
With a resolution and a refresh rate, the last characteristic of the video system to decide on was the color depth. 

Colors are expressed with 16 bits. 4 bits per RGB components for a total of 12 bits allow 4,096 colors. 


\begin{figure}[H]
\begin{minipage}[t]{0.49\linewidth}
  \simg{1.0}{clear_4bit.png}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.49\linewidth}
  \simg{1.0}{dark_4bit.png}
\end{minipage}
\caption*{CPS-1's 12-bit per color cube.}
\end{figure}
  
The four remaining bits express brightness so 16 shades of a color can be achieved. Overall, 65,536 different colors are available.

\begin{figure}[H]
\nbdraw{brightness}
\caption*{All 15 brightness possible using Red \icode{\{0xF,0x0, 0x0\}} base.}
\end{figure}

\subsection{Putting it all together}

Knowing how a CRT works and what decisions Capcom engineers made, we can now connect the dots and understand the video signal as a whole.

With a "pixel" clock coming from the GFX oscillator (16MHz) halved to 8MHz, a color is issued every 1s / 8MHz = 125ns.

The horizontal resolution of 512 mandates a HSYNC to be generated every 512 * 0.125 = 64$\mu$s. The resulting refresh rate is 8MHz / (512x262) = 59.637Hz and a VSYNC must be issued every 1000/59.637 = 16.7ms.

A summary drawing exposes all timing and regions as well as the significant part of the image not usable due to horizontal and vertical blanking.

\begin{trivia}
The horizontal blank between the end of a scanline and hsync is called the "front porch". The blank section between hsync and the start of the next scanline is called the "back porch".
\end{trivia}

\nbdraw{sf2_withoverscan_zero}

Keep in mind that if HSYNC happens 262 tiles (blue vertical line), VSYNC occurs only once. The dashed horizontal red line is only here to represent where the electron gun reset to the top of the screen.

Note on the previous drawing how large vertical blanking is. It allows more operations in the background. On CPS-1, 16 lines are required for a palette page (32) upload, limiting the rate to two per frame.

\begin{figure}[H]
\nbdraw{sf2_withoverscan}
\caption*{Same concept but with image as it appears on a CRT.}
\end{figure}


\subsection{From pen to palette to color}

To generate the color signals, the CPS-1 uses a palette system storing colors via 4 x 2Ki x 1B \icode{CXK5814P-35L} SRAM chips.

\sdraw{0.45}{CXK5814P-35L} 

Individually these are simple memory elements with pinouts explained earlier. Power \icode{+5V}, Ground \icode{GND}, Addresses \icode{A0-A10}, Data \icode{D0-D7}, Write (\icode{WE}), Read (\icode{OW}), and Chip Enabled (\icode{CE}).

What is uncanny is that the component connected to the address lines is not the one connected to the data lines.
 % Instead data is routed towards a DAC.






\nbdraw{video_lookup}

The CPS-B drives the address bus at 8MHz to generate the DAC 16-bit inputs which in turn generates three analog Red, Green, and Blue signals. In parallel, the GFX generates the HSYNC and VSYNC signals, composited into CSYNC.
Notice how one line is used not for addressing but to \icode{CE}ing chip pairs. 

Colors are grouped into palettes containing 16 units (the last index is always transparent). As will be studied later, the GFX system features 6 layers and each of them allows 32 palettes. This brings the total to 6*32*15 = 2, 880 colors which requires 12-bit to be indexed.

% 3,072 colors accounts for 3,072*2= 6,144 bytes. There is a little bit of palette SRAM not used.

 The palette SRAM chip are nearly constantly used to generate colors. It can only be updated during VBLANK. Designing the machine with long blanking was paramount to allow updates. 



 

% \begin{trivia}
% 8 KiB but only 6 KiB is used
% \end{trivia}

% If we were to look at the CRT signals, we would see not only the active scanlines (those visible to users but also the huge HBLANK and HBLANKs section. 


% If this representation help visualizing the blanks, it is not how the CRT inteprets it. By "syncing" (placing HSYNC + VSYNC in the upper left), we see an image closer to what the CRT's gun actually does.
\pagebreak




Twelves famous palettes. Can you recognize them?

\nbdraw{palette_ryu}

\nbdraw{palette_ken}

\nbdraw{palette_chun}

\nbdraw{palette_honda}

\nbdraw{palette_guile}

\nbdraw{palette_zan}

\nbdraw{palette_blanka}

\nbdraw{palette_dahlsim}

\par\noindent\rule{\textwidth}{0.4pt}

\nbdraw{palette_boxer}

\nbdraw{palette_vega}

\nbdraw{palette_sagat}

\nbdraw{palette_bison}

 (Solution: RKCHGZBD\_BVSB)














\section{Graphic system}

\emph{This section would have been impossible to write without Lo\"{i}c Petit's contribution. He has been working tirelessly on understanding the CPS-1 and CPS-2 and generously shared his knowledge.}

The graphic system is the most complicated to understand in the whole machine. It is complex because it must satisfy two demanding neighbors.

On one side, there is Control which requests an elaborated composition of backgrounds and sprites to appear on the screen. The description is much more verbose than a simple integer received by the Sound system to play a sample or a music. The only way to remain efficient is to bend the the rules of layering and share access to resources. 

Not only the graphic registers are exposed, there is also a huge portion of "GFX RAM" which is shared. Control's 68000 writes "draw commands" which the GFX system eventually reads.

On the other side is the 8 MHz Video system which mercilessly demand a pixel color every 125ns. A color must be issued on the dot, no matter what. The problem is a matter of timing and latency since no memory is fast enough to satisfy a pipeline if it were to work on a per-pixel basis. 

Solving both these problems exceptionally well is what made the CPS-1 stand out. It is unarguably the "secret sauce" of the machine. 

\subsection{CPS-A and CPS-B: The ASICs powerhouse}
To make their dream machine become a reality, Capcom did not rely on another company's product. They crafted their own ASICs (Application-Specific Integrated Circuit), tailored to their needs.

% The architecture summary shows the heart of GFX is made of not one but two chips called the CPS-A and the CPS-B. 

\begin{figure}[H]
\nbdraw{ppus}
\caption*{Architecture of the GFX studied in this section.}
\end{figure}




\subsection{Pens and Ink}
The elementary unit of work is a 4-bit value which is an index into a 16 colors palette. Everything, from backgrounds to sprites uses these 4-bit nibbles. A good analogy, and the terminology uses in this chapter, is to picture the GFX manipulating "pens" (palette indexes). The color to appear on the screen is decided not by the pen but by the value at this index, which we will call "ink".

% As a result, this system is completely unaware of what color will end up being issued by the video system to the CRT.

All graphic assets are stored in GFXROM (except for the palette which are described later). Pen values are stored across four bytes in a planar fashion.





\nbdraw{gfx_format}

As a result, the GFX ROM is always read in groups of four bytes.

 \begin{trivia}
 Pen 0xF is always treated as transparent!
 \end{trivia}



\subsection{Elements of drawing}

Games are made of a background on top of which are drawn sprites. The easier to implement from a technical standing point is the background which we will study first.

\subsection{Drawing background}

A background is described in terms of "tiles" which arrangement is described in a map of tiles. The goal of a tilemap circuit is to "rasterize" the "tilemap".

A naive design would work at the same speed as the video system (8MHz). For each pixel (125ns) the GFXRAM would be read to know what tile to display. Then a palette index would be retrieved from the GFXROM. Finally that index would be sent to the palette system where the color would be converted by the video DAC. That would not work.

Even thought the machine uses the fastest type of SRAM, the response time of these component does not permit so many roundtrip. The overhead is too important to complete the operation in just 125ns.

The solution to this problem is to increase throughput by reading pen values in advance and caching the result. To this effect, the CPS-A features 256 bytes to cache information retrieved from the GFXRAM during HBLANK.

 \begin{figure}[H]%
 \nbimg{DL-0311.png}%
 \caption*{CPS-A die. Notice the real estate dedicated to tilemap caching.}%
 \end{figure}%



Another optimization that allows the GFX to keep up with the pixel clock is the streaming of colors codes without intermediate storage. 

The system works with the GFXROM addresses lines connected to the CPS-A which acts as the brain but the data lines  connected to the CPS-B (the legs) where pen values are selected/discarded before being sent to the video system.

The grid alignment works well with streaming because of the predictable screen location of the tiles in the map.

 \begin{figure}[H]%
\nbdraw{gfx_groups}
 \caption*{In Street Fighter 2, a PAL \icode{STF29} decode tile ids into memory offsets.}%
 \end{figure}%

Notice how the GFXROM data is retrieved four bytes at a time via lines groups APD, BPD, CPD, and DPD. 

Keep in mind that at any time, the CPS-B not only receives data from the GFXROM but also stream pen values to the video system. 

% \begin{trivia}
% All home-consoles of the late-80 and early 90s, and even the powerful 16-bit systems such as Nintendo's SNES and Sega's Genesis relied on tilemap systems.
% \end{trivia}



% A tilemap rasterizer circuit consist of a "sampler" inside which is a buffer. When the CRT start drawing a scanline, the sampler consult the GFXRAM to know what to drawn (this is typically a list of tile ids with their associated palette), retrieve a tile width worth of colors from the asset repository (GFX ROM), and issued them to the CRT when the timing requires it.

% As the line is being drawn, the sampler buffer gets depleted (a buffer is typically a few bytes wide) so the sampler goes back to the GFXRAM to retrieve the next tile ID and refill itself in the GFX ROM.

% The process repeats itself until all lines in a frame have been drawn.



% The sampler system allows to move the background vertically or horizontally with minimum circuitry since each axis changes is a simple matter of introducing a delta in the sampler tile coordinates.



% \subsection{Drawing backgroundS}
% A visual improvement which appeared around 1985 in Capcom games was to use a second tilemap to generate parallax backgrounds. In this case, the board must feature a second sampler and have a compositor on top to handle tiles priority.

% \nbimg{tilemap_two_sampler.png}

% However since the memory access time remains the same but twice as much data must be retrieved from the GFX RAM and ROM, the board is facing a bandwidth issue. 

% The solution is to either increase the bus throughput by using wider data lines or increase the sampler buffer size.

% The advantages of these samplers compared to the framebuffer used by PCs is that they cost less. Memory was very expensive and using a few small buffers compared to a full "frame-buffer" made a significant difference. The second advantage is that by reducing the amount of data to write, a higher framerate could be reached since no CPU could write a full framebuffer fast enough while performing at 60Hz.



\subsection{CPS1 Tilemaps}
The CPS-1 features three layers called SCROLL1, SCROLL2, and SCROLL3. They all rely on tilemaps made of 64x64 tiles. However they all use different tile dimensions. 

SCROLL1 uses tiles of dimensions 8x8 resulting in a total dimensions of 512x512.

SCROLL2 uses tiles of dimensions 16x16 resulting in a total dimensions of 1024x1024.

SCROLL3 uses tiles of dimensions 32x32 resulting in a total dimensions of 2018x2048.


\vfill
\begin{figure}[!b]
\img{color-00003208.png}
 \caption*{Street Fighter 2.}%
 \end{figure}%
\pagebreak

Each tilemaps has a maximum capacity of 32 palettes.

For Street Fighter 2, the developers used layers with different horizontal scroll speed to implement parallax. The sprites in black (drawn on a fourth layer called "OBJ" which is discussed later) are used not only for the characters but also for the "GUI" elements.

Other titles such as Forgotten World required all the sprites the machine could provide. To not waste any, the design team chose to implement the GUI with SCROLL1. It is a good trade-off because the only restrictions is that elements are aligned on a 8 pixels grid which is not really a problem for a GUI.

\fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} SCROLL1, \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2, \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3, \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ.

\vfill
\begin{figure}[!b]
\img{rgb-00003208.png}
 \caption*{Street Fighter 2 ... with layers!}%
 \end{figure}%
\pagebreak


\subsubsection{Starfields}
Besides SCROLLs, the CPS-1 has two "STARfields" which are always behind the SCROLLs and always in order STAR1 then STAR2. 

For each of these layers, the GFXROM contains no tiles but instead bytecode dictating the position of points as long as palette cycling timing. By using the 32 palettes of each of these layers astutely, parallaxes starfield can be rendered. 

These STARs layers were a great feature for the many space shoot'em up released when the CPS-1 was designed since it saved considerable GFXROM space and artists time. The very first title released on CPS-1, Forgotten Worlds prominently showcased this feature.

\vfill
\begin{figure}[!b]
\img{color_short_forgottn-00000450.png}
 \caption*{Forgotten Worlds.}%
 \end{figure}%
\pagebreak

Alike the tilemaps, each starfield has a dedicated 32 palettes.

\begin{trivia}
The CPS-1 layer system does not use a painter algorithm where pixels are written over and over in a framebuffer. The CPS-B receives a stream of all layers and based on the priority and the potential transparent color code (\icode{0xF}) select the one to send to the video system.
\end{trivia}

The STARs layers also proved useful when designers need a full black background. Instead of using a SCROLL and repeating a tile full of black color codes, they only have to use a STAR and request no stars. So many player starred at a dark night sky and they never knew about it.

\fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} SCROLL1, \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2, \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3, \fcolorbox{black}{mycyan}{\vphantom{W}\hphantom{H}} STAR1, \fcolorbox{black}{myyellow}{\vphantom{W}\hphantom{H}} STAR2, \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ.

\vfill
\begin{figure}[!b]
\img{rgb_short_forgottn-00000450.png}
 \caption*{Forgotten Worlds.}%
 \end{figure}%
\pagebreak









\subsubsection{Draw order and Priority mask}


The drawing order (also called "priority") of SCROLLs and the sprite layer we will see next is entirely configurable (but both STARs must remain behind). Any order can be requested but there is an extra feature available to the SCROLL drawn just before the sprite layer.

Take the example of Final Fight Level 1 where the main characters Haggar and Guy exit the subway. 

We can see, in "back to front" order,  \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3 used for the skyline, \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2 used for the main playground, \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ for the main characters, tires, and barrel sprites, and on top of all \fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} SCROLL1 for the GUI.


\vfill
\begin{figure}[!b]
\img{ff_color-00007375.png}
 \caption*{Final Fight.}%
 \end{figure}%
\pagebreak


This makes sense except for one detail. If we look closely at Haggar, he appears to be both in front and behind SCROLL2.

The CPS-B allows the SCROLL layer behind the OBJs layer to have a special power. If a SCROLL tile is marked property, it can request the renderer to display some of its pixels on top of OBJ instead of behind.

This feature allows to create complex effect where sprites are sandwitched by a SCROLL. Here, the tiles making the "near" portion of the ramp are added to the priority mask. Then four pens (resulting in colors \fcolorbox{black}{mask1}{\vphantom{W}\hphantom{H}} , \fcolorbox{black}{mask2}{\vphantom{W}\hphantom{H}} , \fcolorbox{black}{mask3}{\vphantom{W}\hphantom{H}} , and \fcolorbox{black}{mask4}{\vphantom{W}\hphantom{H}}) are set for the priority mask.

Tiles making the "far" part of the ramp are not added to the priority mask so all its color appear behind OBJs.

\vfill
\begin{figure}[!b]
\img{ff_rgb-00007375.png}
 \caption*{Final Fight ... with layers!}%
 \end{figure}%
\pagebreak

\subsubsection{Scrollrow}
SCROLL 2 was given the special ability to scroll rows of a tile horizontally based on the vertical drawn position. 

This capability is commonly known as "scrollrow" and is implemented via a table of 256 9-bit integers (one for each line) in GFXRAM.

This feature stresses the cache system in the CPS-A because more than a tile width must be retrieved.

The starfield and rowscroll feature are good example of how difficult it is to design hardware because doing it well consist in accurately predicting what will be/ useful and what won't. 

\vfill
\begin{figure}[!b]
\img{color-00016530.png}
 \caption*{Street Fighter 2}%
 \end{figure}%
\pagebreak


\subsubsection{Choosing features}


If starfields were heavily used in the very first CPS-1 game, "Forgotten Worlds", and prominently featured in the second one , "Strider", rowscrowl on the other side saw no usage for nearly two years. 

Relegated to implementing flames effects in "Magic Sword" and hazy background in "Carrier Air Wing", rowscrolling was rarely used in the five titles\cite{mame_cps1_video} it was featured.

Ultimately, the balance of these two features found itself reversed when rowscroll was used to implement a beautiful per-line floor parallax in Street Fighter 2, massively contributing to the graphic appeal of the game.


\vfill
\begin{figure}[!b]
\img{color-00016530.png}
 \caption*{Street Fighter 2 ... with scrollrow!}%
 \end{figure}%
\pagebreak







\subsubsection{Pushing the limits}

Besides priority mask, tiles can be flipped horizontally and/or vertically but there is no scaling or rotation possible. Furthermore, a CPU without access to the GFXROM make it impossible to "plot" pixels. That did not prevent designers to be implement clever tricks.



In Ghouls 'n Ghosts first level, on top of hordes of zombies, a Red Arremer, and unforgiving control, the player must face the weather. Wind picks up and soon come an heavy rains. If you look at the screenshot of the layer below, all layers are used. 

To add rainfall, developers leveraged temporal blending on the same layer as the GUI (\fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} SCROLL1). 

\vfill
\begin{figure}[!b]
\img{rgb_ghouls-00009167.png}
 \caption*{Ghouls 'n Ghosts with GUI.}%
 \end{figure}%
\pagebreak

Every five frames, a full screen of rain tiles is displayed instead, resulting in a convincing effect.Temporal blending is often used to implement translucency. 

Tile granularity was circumvented in the intro Carrier Air Wing where fizzledade is in fact pre-rendered tiles.

\draw{fizzlefade}
 

\vfill
\begin{figure}[!b]
\img{rgb_ghouls-00009168.png}
 \caption*{Ghouls 'n Ghosts when rain falls.}%
 \end{figure}%
\pagebreak




\subsection{Drawing Sprites}
Drawing sprites resolves around the same problematic as tilemap involving bandwidth and latency only it is more difficult because sprites can appear anywhere and are not aligned in a grid.

In order to fully appreciate how the CPS-1 solved this problem, it is worth understanding how other platforms tackled it.

\subsubsection{Hardware sprite}
A sprite circuit can be implemented using the same logic as a tilemap. Only it is a special case where there is only one tile and the map cannot be scrolled horizontally or vertically.

Every HSYNC, the GFXRAM is read to know if a sprite appears on the next scanline. If it does, the circuit makes sure it intercept tilemap pens to issue sprite pens instead. 

That is a solution that has two problems. It requires one circuit per sprite which is expensive and the one-to-one complexity make it impossible to scale to more than a few units. Nonetheless, this is the solution used by machines such as the Commodore 64 which advertised their circuitry as "hardware sprites".


As limiting as it sounds there is a bit of flexibility thanks to a technique known as multiplexing. A C64 has 8 sprites "units" but that does not mean it can only draw eight sprites on the whole screen. It only means it can only draw eight sprites on the same scanline.

As the CRT progresses down the screen, a sprite unit used above can be reused to draw sprites located lower on the screen. By changing the configuration during HBLANK, many more than eight sprites can be drawn. This trick was extensively in games to reach well over 100 on screen.


Likewise, by using built-in multiplexing, the Commodore Amiga placed an horizontal limit of 8 pixels for its sprites width but allowed unlimited height.

\subsubsection{Line buffer}
To scale better and increase the number of sprites supported, hardware designers introduced the concept of line buffers. 

A linebuffer system requires a bigger buffer, as wide as a visible line on the CRT. The buffer is populated with pen codes by a Pixel Processing Unit. The number of sprites, dimensions and rotation capabilities depends on how much work the PPU is able to do. 

The limiting factor is that the line buffer can be written only during HBLANK (16$\mu$s) since it is used the rest of the time to feed the CRT.

System like the Super Nintendo use a line buffer with an impressive PPU resulting in breathtaking fullscreen visuals effects involving Mode-7/HDMA which particularly shun in games like F-Zero or Pilot Wings.








\subsubsection{Double Line buffer}
A straight forward way to make a GFX more powerful is to simply give it more time to do its jobs. The merciless 8MHz pixel clock cannot be cheated but the pipeline can be made deeper.

By using two linebuffers in alternance, the GFX increases its latency but also frees itself from rendering only during HBLANK. While a linebuffer is fed to the video, another one is rendered. This allows drawing during one full scanline (64$\mu$s) and a GFX 4x more capable. 

This choice, made by SNK for its Neo-Geo allowed gorgeous titles such as "Metal Slug" to be build entirely with sprites without using tilemaps.

% The counterpart of this architecture is not only the price of a second line buffer but also an humongous amount of GFX ROM to store the assets which drive up game price tag significantly. 



\subsubsection{CPS1 Sprite FrameBuffer}
Capcom hardware designers wanted something even more powerful than a double line buffer. To allow more time than a scanline to the PPU, the CPS-1 was built around a double sprite framebuffer. To host these framebuffers, the machine uses dedicated memory called VRAM.

With a double sprite framebuffer, the PPU does not just draw a line in advance but a whole screen. This technique gives even more time for the graphic chip to do its work since drawing time increases from (64$\mu$s) to 16.7ms (260x more time!). 

The gain is massive but it comes with three drawbacks. 

First, the price of the machine goes up since it requires much more buffering capacity. At the resolution of 384*224, 9-bit for each coordinate needs to be stored (5-bits palette index + 4-bit color index).


The second impact is on the bus because a massive amount of data is now written and read to/from the VRAM. It requires so much bandwidth that an especially large data bus connecting the GFX ROM and the VRAM had to be created.

Lastly, there is the problem of tilemap and sprites rendering desynchronized. When the 68000 writes the desired layout in the GFXRAM, the graphic system picks it up but channels background tiles and sprites tiles to different locations.

The tilemap rasterize outputs directly to the video system but the sprite layer is rendered to the VRAM framebuffer where it will be picked up on the next frame.
 


The issue is visible on the next drawing. On frame 1, the scrolls of frame 1 are displayed. On frame 2, the scrolls of frame 2 are displayed but along with the sprite from frame 1. On frame3, the scrolls of frame 3 are displayed but along with the sprite from frame 2. 

\nbdraw{latency}

\begin{trivia}
The sync issue is particularly noticeable in Final Fight level 2. The subway wagon moves up and down to simulate rails but inside the handles on the ceiling and characters appears to lag behind.
\end{trivia}

\subsubsection{CPS1 Sprites Tile}
With its architecture based on a double sprite framebuffer, Capcom reached its target to build a powerful system able to move an immense volume of sprites. But performance was only one part of the equation, they also had to come up with a flexible way for artists to use it.

Up to that point, the frustration spur from sprite dimensions (all sprites had to had the same sizes), shapes (mandatory rectangular) and colors (one sprite could use at most one palette). 

The CPS-1 lifted these three limitations by abandoning the concept of sprites. The CPS-1 does have a "sprite" layer but it is made of tile of dimensions 16x16 pixels. Called OBJ (for OBJects) its TILEs can be arranged however an artist requires to build sprites of arbitrary shapes and sizes. 

OBJ has 32 palettes which any tile can freely use for a total of 480 colors.
% This system also allows to us more colors since each OBJ can use any of the 32 palettes available on the OBJ layer. This greatly increase the total usable colors to a total of 32*16 - 32 = 480 sprites colors. 




\begin{minipage}[t]{0.49\linewidth}
  \sdraw{1.0}{ryu}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.49\linewidth}
  \sdraw{1.0}{zanghief}
\end{minipage}


% made of 4-bit color index where 0 is always considered transparent. Sprite tile arrangement is described along with SCROLL tiles in the GFXRAM. 

Ruy's hurrican kick pause is 27 OBJs (3,456 bytes). Zanghief standing pause is 35 OBJs (4,480 bytes). 

\begin{minipage}[t]{0.4\linewidth}
  \sdraw{1.0}{guile}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.56\linewidth}
  \sdraw{1.0}{sagat}
\end{minipage}

Guile crouching pause is 18 OBJs (2,304 bytes). Sagat's low kick pause is 21 OBJs (2,688 bytes). 



\sdraw{1.0}{kingpin}

Kingpin in "The Punisher" is made of 69 tiles and take half the screen.


Tiles in the OBJ layer can have attributes to be rendered horizontally and/or vertically flipped but there is not support for rotation or scaling.

\begin{minipage}[t]{0.535\linewidth}
  \nbdraw{damnd}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.445\linewidth}
  \nbdraw{damnd2}
\end{minipage}

 When Final Fight boss, Damned, does its back-flip, the CPS-1 does not rotate anything. Two sets of tiles are used and X flip/Y flip generate two extra mirrored sets. The effect works thanks to fast movement and players's brain interpolation.

 % The system has an advertised capacity of 256 sprite tile per frame \red{(Source?)}.

\pagebreak

The sprite system has a hard limit of 256 tiles. This is a simple constraint decided by how many tile is is able to read from the GFXROM and write to the VRAM during a raster scan (16.7ms).

Because OBJ tiles are the most vercatile (they can be placed independently and anywhere on the screen), it was tempting to use them offset.

Street Fighter II designers pushed the machine on the edge of its limits by using OBJ tiles for the opponents, arena decoration, GUI, and to improve the background parallax further.

When Ken faces Ryu in Japan, nearly 200 tiles are used. But when Street Fighter 2 Champion Edition allowed same character matches on any location, problems started to arise.
\vfill
\img{lack_sprites_color.png}
\pagebreak

\begin{q}{- Akira Nishitani, SF2 Producer}
We carefully planned SF2 so that the biggest character and the second biggest character could just barely fit on screen at the same time. 

But when mirror matches became possible in Champion Edition, that meant that we had to be able to display two copies of the biggest character on screen. We ended up having to remove back- ground elements and such.
\end{q}
To remain within the OBJ budget, the "wind, forest, fire, mountain" ("\begin{CJK}{UTF8}{min}風林火山\end{CJK}") sign is cut from Street Fighter 2 Champion Edition.
\vfill
\img{lack_sprites_rgb.png}
\pagebreak

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001209}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001210}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001211}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001212}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001213}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001214}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001215}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001216}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001217}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001218}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001219}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001220}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001221}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001222}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001223}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001224}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001225}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001226}
\end{minipage}


\pagebreak









\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001227}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001228}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001229}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001230}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001231}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001232}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001233}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001234}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001235}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001236}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001237}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001238}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001239}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001240}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001241}
\end{minipage}

The lack of scaling and rotation was a problem for developers of Street Fighter 2 where the intro called for exactly these operations. 

They faked it with two logos, a small and a large one. Tiles move on a circular pattern. The small to large subitituton happens in one-go at the mid-animation timestamp.

\pagebreak





\subsection{Putting it all together}

We now have enough knowledge to fully understand how the CPS-A and CPS-B cooperate to render graphics.

The two graphics chips closely work together by sharing custody of the GFX ROM and VRAM. The CPS-A generates four interleaved stream of pens (OBJ, SCR1, SR2, and SRC3) by driving the address bus. The CPS-B receives the data and decides for each "pixel" which stream is visible. 

\begin{figure}[H]
\nbdraw{shared_custody}
\caption*{CPS-A (address) and CPS-B (data) GFX ROM/VRAM lines.}
\end{figure}

Besides deciding source and destination of data, the CPS-A also generates LI: (Line increment) and FI: (Frame increment) towards the CPS-B where they are turned into HSYNC and VSYNC for the CRT.

The 23-bit address line to the GFX ROM is special. It is not a raw address but a layerID + tileID within that layer. The PAL \icode{STF29} converts IDs into addresses.


The CPS-B is put under heavy contribution. It must simulatneously write the next sprite framebuffer but also render the current by reading the previous sprite framebuffer and sampling all five other layers.

\nbdraw{vram_rw}

To keep up with the bandwidth requirements, the VRAM and GFX ROM systems are specifically crafted with wide data lines.








\subsubsection{VRAM}
Not only the VRAM system is optimized from an architecture standing point via two completely independents blocks A and B, it also benefit from exceptionally performant components.

A quick glance at the \icode{HM53461P} pins shows that this chip does more than the simple data, address, and control we have seen so far.

\sdraw{0.7}{HM53461P-10}

Able to store 65,536 Ki x 4-bit, the \icode{HM53461P} is peculiar because it not only features a RAM port (\icode{D1-D4}), it also features a SAM "serial" port (\icode{SD1-SD4}).
 
The RAM port is accessed "normally" by first asserting the address lines along with the control lines and then reading or writing on the data lines.

The SAM port is different. Upon asserting the address lines, an internal buffer is latched. Each subsequent control operation automatically increment the address counter.

This design allows RAM and SAM to be accessed simultaneously (although this never happen since when A is read, B is written and the other way around).
 More interesting is the access time which on the RAM port is 100ms and more than twice as fast (40ms) on the SAM port. 

 This is a perfect component for a system that needs to write a few values at varying locations (like when the CPS-B renders a sprite buffer) but read a very large amount sequentially (like when the CPS-B must compose color code towards the palette system).

 On the Street Fighter II board, twelves \icode{HM53461P} are combined into six pairs, resulting in 384 Ki * 8-bit.

\nbdraw{vram}


% \red{Why so much VRAM? You only need two framebuffer with palette data but there is almost 150 KiB too much there. Could it have been a provision for future improvements?}


% \begin{trivia}
% All memory systems are built with either ROM or SRAM. The VRAM system is the only one built with DRAM and therefore has a memory refresh mechanism.
% \end{trivia}


\subsubsection{GFX ROM}
To keep up with the much higher storage requirements, the GFX ROM system is not designed like the others. 

While other chips on the board-B are \icode{27C010} and \icode{27C512}, the GFXROM is made of \icode{MB834200B} (256 Ki x 16-bit). Because of their slow access time of 150ns, they are arranged in a two-way interleave resulting in two 16-bit "channels" data path.


\sdraw{0.8}{MB834200B-15}

On the Street Fighter II board, twelves \icode{ MB834200B-15} are combined for a total of 6 MiB of GFX assets.

\nbdraw{gfxroms}

\section{Copy protection system}

Upon release, Capcom then CEO Kenzo Tsujimoto, was confident the CPS-1 would significantly reduce piracy even going as far as labeling it "impossible to copy".

\begin{q}{Kenzo Tsujimoto, Capcom CEO\cite{gamest38}}
    
The new CP System arcade boards are very important to Capcom in two regards. First, they have much more memory than our previous hardware. Game developers will have free reign to explore new, exciting design ideas and take advantage of the latest technological developments. 

The CP System has upped the level of our developers already.

The second big thing is copy protection. Illegal bootlegs have been a huge problem for us overseas; I believe the CP System is the only PCB hardware today that cannot be copied.

The boards contain various copy protection methods, and their advanced hardware should make it difficult for bootleggers seeking to create knockoffs with today's components. 

Bootlegs don't only hurt us; they're also a nuisance for our customers who think they are getting a genuine board. We see copy protection as one of the main achievements of the CP System.
\end{q}


There were good reasons to be optimistic since Capcom engineers had crammed their platform with protections.

\subsection{Hard piracy}

Hardware pirates produced bootlegs by physically copying Capcom PCBs. All counterfeiters had to do was dump the ROMs content from a legitimate board, buy the same off-the-shelf CPUs and TTLs components (Transistor–transistor Logic), assemble, burn new ROMs, and sell at a discounted rate.

The CPS-1 answer was to use chips which were not readily available to the public. Capcom had Ricoh exclusively fabricate the two custom ASICs, the CPS-A and CPS-B. To protect against reverse-engineered by decapping followed by microscope analysis, metal grids were layered on top of the chip\cite{arcadeHackerCPS1Rev} lines. 


\subsection{Soft piracy}
Software piracy is different from hardware piracy in the sense that it involves operators purchasing an authentic CPS-1 game from Capcom but then getting as many more games as they want without paying for them.

Upon their first (and only) purchase on a CPS-1 based game, the buyer would received a bundle of Board A, Board B, and Board C. If the only thing different between games were the ROM content, they could be dumped, burned on new ROMs and inserted onto Board B. 

By exchanging or selling ROMs, software pirates once again would undercut Capcom.

To prevent software piracy Capcom elected to build as set of tools at the hardware level that could be used by the software to check the authenticity of the board it was running on at runtime.



\subsection{The ever changing CPS-B}
The heart of the protection system is the CPS-B. The idea is to make it behaves differently depending on the game it is supposed to run.

To this effect, twenty-five versions the CPS-B exist\cite{mame_cps1_video} sometimes differing between revision of the same game\cite{cpsBNumbers}.


\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrrr} 
  \textbf{Game Name} & \textbf{Revision} & \textbf{ CPS-B }  & \textbf{ Year } \\               
  \toprule    
\href{}{Forgotten Worlds} & & CPS-B-01 & 1988 \\ 
\href{}{Lost Worlds} & & CPS-B-01 & 1988 \\ 
\href{}{Ghouls'n Ghosts} & & CPS-B-01 & 1988 \\ 
  \toprule    
\href{}{Strider} & & CPS-B-01 & 1989 \\ 
\href{}{Dynasty Wars} & & CPS-B-02 & 1989 \\ 
\href{}{Willow} & & CPS-B-03 & 1989 \\ 
\href{}{U.N Squadron} & & CPS-B-11   & 1989 \\ 

\href{}{Final Fight } & Original& CPS-B-04 & 1989 \\ %ffight
\href{}{Final Fight } & 900112& CPS-B-01 & 1989 \\ %ffightua
\href{}{Final Fight } & 900424& CPS-B-03 & 1989 \\ %ffightub
\href{}{Final Fight } & 900613& CPS-B-05 & 1989 \\ %ffightuc

  \toprule    
\href{}{1941: Counter Attack} & & CPS-B-05 &  1990 \\ 
\href{}{Mercs} & &  CPS-B-12 & 1990 \\ 
\href{}{Mega Twins} & & CPS-B-14 & 1990 \\ 
\href{}{Magic Sword} & & CPS-B-13 & 1990 \\ 
\href{}{Carrier Air Wing} & & CPS-B-16  & 1990 \\ 
\href{}{Nemo} & & CPS-B-15 &  1990 \\ 
  \toprule    
\href{}{Street Fighter II: The World Warrior }&  Original& CPS-B-11 & 1991 \\  %sf2
\href{}{Street Fighter II: The World Warrior } & 910204& CPS-B-17 & 1991 \\  %sf2ea
\href{}{Street Fighter II: The World Warrior } & 910318& CPS-B-05 & 1991 \\  %sf2ed
\href{}{Street Fighter II: The World Warrior } & 910228& CPS-B-18 & 1991 \\  %sf2ee
\href{}{Street Fighter II: The World Warrior } & 910411& CPS-B-15 & 1991 \\  %sf2ef
\toprule    
\end{tabularx}%
}\caption*{A selection of the many Capcom CPS-1 games revisions.}
\end{figure}

Originally, the CPS-B chips changed frequenty. The table above only contains a few of the many PCB revisions, the full list give a good idea of how successful a game was. Street Figther 2 was revised 34 times, while Final Fight reveived 13 of them.

With the released of "Three Wonders", Capcom singled out their chips via configuration micro-code. All CPS-B chips are CPS-B v21.

\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrr} 
  \textbf{Game Name} & \textbf{ CPS-B }  & \textbf{ Year } \\               
  \toprule    
\href{}{Three Wonders} &  CPS-B-21 & 1991 \\ 
\href{}{The King of Dragons} & CPS-B-21 & 1991 \\ 
\href{}{Captain Commando} &  CPS-B-21 & 1991 \\ 
\href{}{Knights of the Round} & CPS-B-21 & 1991 \\ 
  \toprule    
\href{}{Street Fighter II: Champion Edition} & CPS-B-21 & 1992 \\ 
\href{}{Adventure Quiz: Capcom World 2} & CPS-B-21 & 1992 \\ 
\href{}{Varth: Operation Thunderstorm} & CPS-B-21 & 1992 \\ 
\href{}{Quiz \& Dragons: Capcom Quiz Game} & CPS-B-21 & 1992 \\ 
\href{}{Street Fighter II' Turbo: Hyper Fighting} &  CPS-B-21 & 1992 \\ 
  \toprule    
\href{}{Ken Sei Mogura: Street Fighter II} & CPS-B-21 & 1993 \\ 
\href{}{Pnickies} & CPS-B-21 & 1993 \\ 
  \toprule    
\href{}{Quiz Tonosama no Yabo 2} &  CPS-B-21 & 1995 \\ 
\href{}{Pang! 3} & CPS-B-21  & 1995 \\ 
Mega Man the Power Battle & CPS-B-21  & 1995 \\

\toprule    
\end{tabularx}%
}\caption*{After 1991, all CPS-1 games used CPS-B v21.}
\end{figure}


\subsection{CPS-ID check}
The simplest check available is the chip ID. By polling a register, the CPS-B returns its version number which must matches what the code expects. To make instructions patching of the 68000 ROMs more difficult, calls to verify the chip id are placed in several location in the code.

That did not prevent people from trying anyway\cite{strider_conversion}!

\subsection{Moving registers}
Another variation between CPS-Bs is the registers locations. The 68000 memory map of the CPS-B registers does not change, but the offset inside that mapping was altered between versions. Accessing the scroll control, scroll priority, and palette upload registers is done using a different offset for each game.

Additionally, the meaning of each bit in a register can changes like for example SCROLL\_ENABLE.




\subsection{Unexpected behavior detection}
Protection described so far involved an active software and a passive hardware. There is yet another level of protection where the hardware is active by expecting the software to behave properly. If the CPS-B sees the wrong value written to the wrong register, it sets and lock all palettes to black. 

The game still runs in the background and the audio is also behaving properly but the screen doesn't display anything. The only way to recover is to reboot the machine\cite{petitSecurity}.

\subsection{Invalid offset detection}

Each game uses a different amount of assets for each of its SCROLL and OBJ layers. On the "B" board, PAL chips such as the \icode{STF29} discussed earlier are hard-coded with knowledge of the amount of GFX ROM attributed to each layers.

Tile references pointing beyong a range are ignored resulting in rendering "holes" if a game ROMs are inserted in a non-matching "B" board.

\begin{q}{Mame cps-1 video driver}
All graphics are
stored together in the same ROMs but the hardware knows which part of the ROM space
is 8x8 tiles, 16x16 tiles, 16x16 spites, 32x32 tiles, and all games tested only
draw tiles if their code falls in the valid range. 

If a tile is out of range, it is replaced by transparent pixels.
\end{q}

\begin{trivia}
This is why transparent is encoded \icode{0xf}. Pull-up resistors are placed on the board data line. If not data signal is detected, \icode{0xf} is automatically "inserted".
\end{trivia}

\subsection{Multiplication check}
Starting with vB-21, a slightly more robust feature gave the CPS-B the ability to perform multiplications. Two registers are written and a third one can be read. The 68000 code is expected to check that the returned multiplication result is the expected value.

\subsection{Configuration Key}
Up to 1991, all CPS-B variations were burned at the factory. They were set in silicon without a way to re-purpose them after the fact. This was not only expensive to have to revise the hardware circuits for each game, it was also a logistic difficulty to provision enough chips for a success and not be stuck with inventory on an unappreciated game.

To solve this issue, Capcom resolved to stop making different silicon in favor of using a standard configurable CPS1-B.

"Street Fighter 2: The World Warriors" did not get the treatment but starting with "Three Wonders" the CPS-1 vB-21 featured a small internal 18 bytes RAM. This was enough for the chip to retain a configuration dictating its behavior\cite{petitSecurity}.

The configuration RAM was designed to survive when the cabinet was turned off thanks to a battery located  on the soldering side and connected to the CPS-B. The chip was even designed to survive having no battery for a few minutes to allow battery replacement.

\begin{trivia}
These battery worked remarkably well since thirty years later you can still find some of these board in working condition.
\end{trivia}

\subsection{Suicide batteries}
The infamous "suicide" nickname came from the effect of losing power. A CPS-B without power lose its configuration and resets all its registers to "default" values that none of the games use. Capcom offered a battery replacement to ressurect boards "C" which had committed sepuku but overtime ceased. 

As the reader will have guessed, passionate fan found a way to bring these games back to life.

The first method is called "phoenix". It is a tedious process which consist in dumping a game ROM and patch the CPS-B register access to use the "default value"\cite{csp1_phoenix}. The insane people doing this are so good at it that they even change the splash screen of the game to feature a "Phoenix Edition" icon.

The second method is even more impressive since it involved circuit surgery by re-uploading the configuration into the CPB-B, essentially de-suiciding them\cite{arcadeHackerCPS1Desuicide}.

\nbimg{phoenix_screen.png}





\section{Epilogue}
From 1988 to 1995, Capcom used the CPS-1 to release thirty+ titles. These seven years saw the birth of three of Capcom most loved franchise, Ghouls’n Ghosts, Final Fight, and Street Fighter 2.

To Capcom, the CPS-1 was a gamble that paid off hundredfold, allowing them to become a video-game household. To players, the games were a series of beautifully crafted titles which provided not only entertainment but also unforgettable memories with a quality so high that some of these titles are still played today. To engineers, it is simply a beautiful machine.

Everybody won. Even those who where not supposed to. The one aspect upon which the CPS-1 could be criticized is its ability to impair piracy. But it would be unfair to fault Capcom engineers on this point.

 The CPS-1 not only featured a high level of security, it kept on adding more. But a copy-protection system exists to deter reasonably motivated attackers. Capcom's games were so loved and so successful that they became the object of an unprecedented level of scrutiny over an extended period of time.

Of all the security measures, it would have been fair to assume the ASICs would be a rock. Astonishingly, CPS-A and CPS-B replicas were manufactured under the name "COMCO"\cite{arcadeHackerCPS1}. It is unknown if an insider leaked the schematics or if someone made it their life mission to reverse-engineer these chips but it did happen.

As crack appeared in its shield, Capcom did not give up on protecting its tiles. As it had proved itself able to evolve and compete in the arcades, it embraced the challenge to always remain one step ahead of bootlegers.

\subsection{CPS-1.5 Kabuki}
In 1992, Capcom released the CP System Dash (a.k.a CPS-1.5). Fully encased in a gray plastic box, it introduced a fourth satellite "Qboard" PCB to handle playback of positional three-dimensional Qsound audio. In total, five games would be produced until late 1993.

\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrr}
  \toprule    
  \textbf{Game Name} & \textbf{ GFX }  & \textbf{ Year } \\               
  \toprule    
\href{}{Cadillacs and Dinosaurs} & 4 MiB & 1992 \\ 
\href{}{Warriors of Fate} & 4 MiB & 1992 \\ 
\href{}{The Punisher} & 4 MiB & 1993 \\ 
\href{}{Saturday Night Slam Masters} & 6 MiB & 1993 \\ 
\href{}{Muscle Bomber Duo: Ultimate Team Battle} & 6 MiB & 1993 \\ 
  \toprule    
\end{tabularx}%
}\caption*{Capcom CPS-1.5 based arcades games.}
\end{figure}

The CPS 1.5 is noteworthy for its improved copy-protection where the audio instructions are stored in encrypted ROM. The audio CPU is a special Z-80 dubbed Kabuki\cite{arcadeHackerKabuki} able to decrypt instructions on the fly.

The encryption scheme is symmetric with the private key being stored in the Z-80. It is not burned in the silicon but, alike the CPS-1 configuration, stored via RAM. To keep that key alive, pin 28 is re-purposed from "DRAM refresh" (the sound system uses SRAM) to provide power via a second "suicide battery". 

\begin{trivia}
The protection provided by CPS-1.5 held remarkably well over the years. It was only broken in the early 2000s\cite{ame_kabuki}.
\end{trivia}

\subsection{CPS-2}

With significantly improved capabilities thanks to its increased ROM capacity and higher processor clocks the CPS-2 instantly became a smash-hit, in particular thanks to the Street Fighter Alpha series. 

From 1993 to 2003, fourty-two games would be published, the last one being "Hyper Street Fighter II: The Anniversary Edition".

In terms of copy-protection, Capcom once again cranked up security. Not only the platform features the Kabuki audio instruction encryption, it also features encrypted game logic. 

Thanks to a custom CPU, ABI compatible with the 68000, instructions retried from the ROM can de decrypted on the fly. Alike other systems, the private key is stored in a yet another battery-powered RAM.

Additionally, GFXROM data was shuffled.

\begin{trivia}
This protection was remarkably strong and held for nearly 10 years. It only fell when the "CPS-2 Shock Group" attacked it in 2003\cite{cps2rebirth}.
\end{trivia}



