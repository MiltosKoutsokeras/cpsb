\chapter{GFX System}
Since the graphic pipeline of the CPS-1 is hard-coded in the silicon of the CPS-A and CPS-B, there is no code to write and nothing to compile. 

\begin{figure}[H]
\sdraw{1.0}{gfx_arch}
\caption*{The GFX System components}
\end{figure}

The only task is to convert graphic assets into GFXROM format. Conveniently, all assets use the same pixel format where four bytes encode eight pen values. However it would be an oversimplification to think that slicing PNG into tiles and placing them anywhere in the ROM is enough.

The major constraint to consider is that GFXROM have "hard-coded regions" where OBJ, STAR1, STAR2, SCR1, SCR2, and SCR3 must reside. If a tile is not where it should, the draw command is simply ignored.

On the Street Fighter II board we have studied so far, the \icode{STF29} PAL slice the 6MiB GFXROM in four areas. 

A board running Final Fight has a \icode{S224B} PAL which also uses four areas but with different offset and proportions over 2MiB. 

A PAL programmed for Forgotten Worlds board, the \icode{LW621}, is more complex since it divide the GFXROM in six areas to also include STAR1 and STAR2 bytecode.


\section{Tile format}
All tiles are stored continuously in memory, using groups of four bytes encoding eight pens. Rows of pens are stored one after another. The dimension of a tile varies depending on the layers. OBJ and SCR2 uses the same 16x16 tiles which mean their tiles are 16*16 / 2 = 128 bytes. For the fine tuned SCR1 which uses 8x8, each tile takes 32 bytes. Finally the larger SCR3 uses 512 bytes for each of its 32x32 tiles.

\section{GFX Layout}
The EPROMs are organized in groups of four chips and serialized. On a board like Street Fighter II, we find three groups of four. Inside each group, chips are interleaved every two bytes.

\nbdraw{gfx_interleave}

\section{Channels}\label{channels}\index{Channels!Practice}
The channels mentions earlier are now visible. ROM \icode{01} and ROM \icode{02} are respectively on channel 1 and channel 2. Likewise, ROM \icode{03} and \icode{04} are channel pairs. The same division is applied to the rest of the ROMs with the same principle. 

We can (hopefully) better see here how issuing the same address on two channels allow to retrieve the two first byte and so on.

\nbdraw{build_graph_gfx}











\section{Back then...}
The creation of artwork for a game always started with pencil and paper before moving to digitizing. On a big title such as Street Fighter II, up to twenty artists worked in parallel to produces artwork.

\subsection{Pen and Papers}
A sprite was typically drawn twice, first as a concept art without details in order to captures the essence of a character pose as well as proportions and sense of movement. Once satisfactory, a second phase involved a more detailed drawing.

Even though it was no the norm, both iterations could be done by the same artist, especially if the topic was dear to their heart.

\begin{q}{Akiman}
I created Chun-Li’s graphics in just 1 month.
\end{q}

However, it was often the case that the lead designer took care of the first iteration, while delegating the fine-tuning to OBJ artists. In the case of Final Fight (page \pageref{ff_design}), Satoru Yamashita animated Guy and Haggar but Akiman drew the key animations for both of them.



\begin{q}{Eri Nakamura}
When I joined on Street Fighter II, Akiman had already done the rough drafts. 

There were four of us as character leads - Satoru Yamashita , Yoshiaki Ohji, and Ikuo Nakayama in addition to myself. Satoru was the most skilled, so he would take Ryu and Ken. 

One day, Akiman brought us the rough sketches of a pro wrestler, sumo wrestler, and a beast, and said "decide who does what." To be fair, we played paper-rock-scissors to determine!
\end{q}





\subsection{Aspect ratio}
The one constant between these iteration is that all work had to be done on non-square grid paper. In order to compensate for the non-square pixels of the CPS-1, artists had to draw with proportion that pre-stretched drawing vertically. 

\begin{figure}[H]
\img{ff_design.jpeg}
\caption*{Final Fight Guy's key frame by Akiman}
\label{ff_design}
\end{figure}

The non-square pixels are visible in Guy's concept art. The "pixels" are grouped in elements 16 by 16, resulting in vertically stretched rectangles.



\img{smc-70_ad.jpg}


\subsection{Digitizing art}
To digitize their drawings, Capcom employees used SMC-70 computers. Manufactured by Sony, the SMC-70 hit both the US and japan market in the end of 1982. What is particularly noteworthy about this machine is that is built around extensibility. 

The main element of a SMC-70 features its keyboard and the core parts such as the z80 running at 4MHz, 64KiB RAM, and 64 KiB of VRAM. The rest is entirely configurable via daisy chained extenders. 

This architecture allowed Sony's machine capabilities to range from simple office work to a powerful video editing tool in its most extensive modification. 

\begin{figure}[H]
\img{sm70_drawing1.png}
\caption*{A SMC-70 extended with a SMI-7012. Power supply in the back.}
\end{figure}

\subsubsection{Noteworthy capabilities}
The substantial list of extensions and peripherals, totaling nearly 40 pieces, conveys Sony's sense of innovation and malleability bread in its SMC-70. Improvements ranging from a simple a extra floppy-disk drive to a full CPU swap replacing the 8-bit z80 with a 16-bit Intel 8086.  

\begin{figure}[H]

\begin{tabularx}{\textwidth}{rrX} 
  \toprule 
  \textbf{Extension Name} & \textbf{Peripheral Name} & \textbf{Function} \\               
  \toprule    
\texttt{SMI-7011} & & 3.5" floppy drive bay (internal with 1 drive)\\ 
\texttt{SMI-7012} & & 3.5" floppy drive bay (internal with 2 drives)\\ 
\texttt{SMI-7013} & & 3.5" floppy drive bay (external with 1 drive)\\ 
\texttt{SMI-7014} & & 3.5" floppy drive bay (external with 2 drives)\\ 
\texttt{SMI-7016} & & Floppy Disk Control Unit\\ 
 & \texttt{SMI-7020} & Dot Matrix Printer\\ 
\texttt{SMI-7031} & & RS232C Serial Interface\\ 
\texttt{SMI-7032} & & IEEE-488 Interface Unit\\ 
\texttt{SMI-7050} & & Cache Disk Unit\\ 
\texttt{SMI-7056} & & Supercharger: 5MHz i8086 w/ 256 KiB RAM.\\ 
 & \texttt{SMI-7060} & 10-Key Numeric Key Pad\\ 
\texttt{SMI-7070} & & Video Signal Converter\\ 
\texttt{SMI-7073} & & RGB Superimposer\\ 
\texttt{SMI-7074} & & NTSC Superimposer\\ 
\texttt{SMI-7075} & & Videotizer\\ 
\texttt{SMI-7080} & & Battery Back-up Unit\\ 
\toprule
\end{tabularx}%
\caption*{SMC-70 extensions and peripherals\cite{smc70tech}}
\end{figure}


% 


The only limit to the daisy chain extension system is the capacity of the power supply which also must be located at the very back of the chain. 

First 3.5" floppy reader (also invented by Sony in 1981), coming in single or double bay. ability to display kanji character.

 \begin{figure}[H]
 \center
\begin{tabularx}{0.35\textwidth}{rrr} 
  \textbf{Width} & \textbf{Height} & \textbf{Colors} \\               
  \toprule    
160& 100& 16 \\
640& 200& 4 \\
320& 200& 16 \\
640& 400& 2 \\
\toprule
\end{tabularx}%
\caption*{Sony SMC-70 resolutions}
\end{figure}

Talk about resolution an the wooping 16 colors display. The goal was mostly to super-impose text on TV signal.


\subsection{Tools}

There are no scanner on the list of peripherals. The drawing were digitized by hand.

The tool used, TCE (Tiny Character Editor). Although no screenshot ever merged, Capcom employee gave a rough description of the rough condition they worked with.

\begin{q}{Koichi Yotsui (Strider producer)}
You had a 16 pixel grid, a 16-color palette, and that was it.
\end{q}

The task at hand was to look at the detailed drawing, and decide which color from the palette would be used for this coordinate. The value was then set via TCE. No mouse but some people built a joytick. Most productive, Akiman, used a play keyboard.

\begin{q}{Akiman\cite{akiman}}
I used a keyboard to draw all the graphics for Vampire and Street Fighter 2.
\end{q}

% \img{smc70_genlock.jpg}



Running on CP/M OS.
Sony's machine featuring  It could be extended had high resolution of 320x200 in 16 colors and...no mouse!



\img{smc70_keypad.jpg}






% \subsection{Following the paper trails}








\subsection{Tracking ROM space}

If breaking free of the rectangular sprites was a blessing for the artists, it was a problem for Capcom project managers. In an era where ROM chips were very expensive, a game was allocated a ROM budget at its beginning which it could not exceed.


Before the CPS-1, remaining within the budget was a simple matter of a division. The number of sprites allowed to the art team was ROM size / rectangular sprite size. But the free form factor introduced a tracking problem.



 \begin{figure}[H]
\nbdraw{0x3300}
\caption*{Dhalsim reconstructed sheet. Tiles are 16x16}
\end{figure}

The solution came with papers and scissors.

\begin{q}{Akira Nishitani, SF2 Producer (Capcom)}
In order to make the best use of the capacity we had, we wrote the ROM’s capacity on a board, and cut and paste the pixel characters on the board. If there was space left on the board, then there was open capacity in the ROM. So, from there we started filling in the spaces, like a puzzle. We saved making the ending for last, and by the time we got there we were all out of capacity. We were wondering what to do, when we found a board that had gone missing under a desk.

We called it the "Mirac-ulous Memory."
\end{q}



 \begin{figure}[H]
\img{rom_sheet_dhalsim.jpg}
\caption*{Dhalsim released paper sheet}
\end{figure}

Only two of these sheets have ever been released, one mostly featuring Dhalsim\cite{ffdevinterview} and another of referred to as Ryuy sheet\cite{htmcc}. Thanks to the imprint left in the GFXROM, all other spreadsheet can be reconstructed thank to our knowledge of the pixel format and layout. 



For a game like Street Fighter II, a budget of 6MiB GFX was approved. With 4.6 MiB dedicated to sprites, 144 OBJ sheets were printer. That was a lot at the time and only warranted because the team had managed to score a huge hit with Final Fight on a tiny 2MiB budget. 




 \begin{figure}[H]
\nbdraw{0x4500}
\caption*{Ryu reconstructed sheet. Tiles are 16x16}
\end{figure}


Comparing the released material with what actually shipped is the source of many discoveries and hypothesis. 

The Dhalsim sheet sits at offset \icode{0x3300} in the GFXROM. It is a near perfect match with the paper version except for the portion starting at \icode{0x60}. One of the pose was dropped in favor of Chun-li animation "Hundred Rending Legs" which would indicate it was a later addition. 

 \begin{figure}[H]
\img{rom_sheet_ryu.jpg}
\caption*{Ryu released paper sheet}
\end{figure}

Ryu's sheet \icode{0x4500} allows to guess even more about the production process. Large coherent sprites show that at the beginning of the production process multiple sheet were allocated on a per-character basis. Tile were layed out and kept together as much as possible to facilitate visual inspection.

As the project progressed the team scrapped the bottom of the barrel and started to allocate space on a per-tile basic, sometimes spreading a character pose across multiple sheets like in Dhalsim sheet where can be found portions of Blanka.


\subsection{Dotting}


With no scanners available, digitizing was done manually by looking at the paper grids and decide what color would be the most fitting. The danting task was called "dotting", also known as in North America as "Pixel Art". 

Employees were free to use the technique that was the most effective to them.


\begin{q}{Akiman\cite{ar20160404}}
  As everything was in hexadecimal we used the 0-F keys and the arrows to make the sprites. There was this one guy who made a complete racket mashing away on his keyboard. He used to do overtime and didn't even sleep, so we'd all have no choice but to stay awake and keep working as well.
\end{q}

 \begin{figure}[H]
\img{smc-70_capcom.png}
\caption*{An actual SMC-70 "workstation" in Capcom studio}
\end{figure}









\subsection{Saving tiles}
Artists invented many tricks to reuse tiles and avoid allocating tiles in the sheets. In Street Fighter 2, there was only enough GFXROM for eleven challengers. Ken is a patchwork and a palette swap on top of Ryu tiles base. It "weights" only 98,304 bytes.

A remarkable achievement compared to characters such as Zanghief (622,592 bytes), Honda (491,520 bytes) or Ryu (442, 368 bytes). 

\begin{minipage}[t]{0.19\linewidth}
  \sdraw{1.0}{patch_ryu0}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.19\linewidth}
  \sdraw{1.0}{patch_ryu1}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.19\linewidth}
  \sdraw{1.0}{patch_ryu2}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.19\linewidth}
  \sdraw{1.0}{patch_ryu3}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.19\linewidth}
  \sdraw{1.0}{patch_ryu4}
\end{minipage}

Final Fight is even more impressive. Made on a 2MiB GFXROM budget, it featured a whooping 21 enemies and six bosses. While most bosses are originals, the minons are in fact made of only seven bases.

% \begin{minipage}[t]{0.20\linewidth}
% \simg{1.0}{enemy_goriber.png}
% \end{minipage}
% \hfill%
% \begin{minipage}[t]{0.20\linewidth}
% \simg{1.0}{enemy_billbull.png}
% \end{minipage}
% \hfill%
% \begin{minipage}[t]{0.20\linewidth}
% \simg{1.0}{enemy_wongwho.png}
% \end{minipage}


\begin{q}{Nishitani, Capcom – 1991 Retrospective Interview}
Everyone on the development thought Final Fight was going to be allocated with a large memory capacity, but we were wrong.
That’s why the final boss Belger hops around like that: we didn’t have enough memory to add more graphics for a walking pattern. 

However, making something cool with limited resources is like a puzzle to me, so I thought it was fun. 
\end{q}

DRAWING of billbull, wonwho and thirt HERE.

 \begin{figure}[H]
\nbdraw{0x0100}  
\caption*{Ryu/Ken sheet}
\end{figure}

Ryu and Ken use the same seven first colors of their palette to facilitate the patching process. 

\nbdraw{palette_ryu}


\nbdraw{palette_ken}



 \begin{figure}[H]
\nbdraw{0x4e00}
\caption*{Sagat's sheet}
\end{figure}

Sagat laughing animation is double optimized. The sequence is made of two poses where only the bust is replaced while the legs remain the same. Moreover, the left leg is missing. It is reconstructed at runtime using an horizontal mirror of the right leg found at \icode{0xB9}.

\begin{trivia}
The capacity of the ASICs to flip tiles horizontally was used extensively in Street Fighter II when challengers facing left or right. Not really an issue for symetrical characters, except for Sagat who' eye patch changes side when he turns.
\end{trivia}

\pagebreak

\subsection{Team structure and Culture}

There was a hierarchy in the artists working on graphic assets. 

\begin{q}{Akiman\cite{akiman2003}}Planners at the top. Junior artists work on backgrounds, while more senior get to work on sprites.
\end{q}

As layered as they where, operations where not set in stone and employees could climb the ladder quickly. Akiman was hired on "Dyn Side Arms" as a SCROLL artist. Two years later, he was a Planner on Forgotten Worlds and went on to work on Final Fight and Street Fighter 2.

 % \begin{figure}[H]
\img{sf2-credit.png}
% \caption*{Capcom protecte}
% \end{figure}

\begin{trivia}
Checking \url{mobygames.com} "game credits" section confirms that specialties via titles such as \textbf{OBJ}ects designers and \textbf{SCR}oll designers.
\end{trivia}

% \begin{trivia}
Out of the team of 40 working on Street Fighter II, 20 were artists working on character designs, faces and backgrounds reporting to Akiman\cite{sf2_oral_history}.
% \end{trivia}



\subsubsection{Poaching and Work Ethic}
Retaining talent was a priority. As seen on credit screen of Street Fighter II (see previous figure). Artists were only credited by their nicknames.

Despite its precaution, Capcom lost numerous employees to SNK over the years. Among them was Takashi Nishiyama who made Street Fighter 1 and then went on to direct Fatal Fury' The King Of Fighters\cite{YoshikiOkamotoTakashiNishiyama}.
 

% In its early years, Capcom organized its pipeline to produce multiple games in parallel. Three teams, named first, 2nd and 3rd Planning Rooms worked side by side. 

% As it grew and diversified, the gaming company restructured itself in 1988 to be made of two divisions. One dedicated to arcades and the other home consoles. 

% After its restructuration, Capcom kept the same modus operantis where each team were siloed from each others with an internal organization favoring a strong sense of hierarchy. 

Preventing attrition did not mean to let employees work at their leisure. A strong working culture was established from the very top.

\begin{q}{Akiman\cite{akiman2003}}
  We had vacation days, but Okamoto (Capcom development leader) would get mad if you took the day off. A lot of people got yelled at by him for that, “Hey, why weren’t you here on Sunday?!”

  I don’t think anyone can beat my record for “percentage of time lived at Capcom.” During game developments, I always slept under my desk. I had a whole futon laid out and everything! When things were really busy, Yoshiki Okamoto  would be setting new deadlines every 10 hours, so I couldn’t leave my computer… that’s how I acquired the habit of sleeping under my desk. 

  By the way, even now that I’m freelance, I still sleep under my computer desk at home.
  \end{q}











\subsection{Inspiration}
For Street Fighter II, artists inspiration came from various outlets. 

Mangas such as "Yasunori Katō" helped to give birth to Dictator while Tao from "Harmagedon: Genma Wars" was part of the genesis of Chun-Li. 

Boxer. Ryu, Ken, Sagat, and Zangiev were inspired by real life athletes, respectively Mike Tyson, Mas Oyama, Joe Lewis, Sagat Petchyindee, and Victor Zangiev Zhanghief.

\begin{trivia}
Originally called M. Tyson, the boxer was renamed to "Balrog" for the US release, out of lawsuit concerns. 
\end{trivia}

% \begin{figure}[H]
% \img{sf_art_research.jpg}
% \caption*{Original characters}
% \end{figure}

For the backgrounds, Hollywood came to the rescue.

\begin{q}{Akiman\cite{ffdevinterview}}
I remember stitching together a few movies to make a presentation. “Streets of Fire” and Charles Bronson’s “Hard Times” were the ones I used back then. Basically movies about fighting. I really took the chairman’s words to heart – “Use movies!” he said, so I took that to mean we should just openly plagiarize them!
\end{q}

Employees did not get paid to a watch movie. They got paid to watch three movies at the same time!

\begin{q}{Nishitani\cite{ffdevinterview}}
We didn't have a whole lot of time, so we had a 3-monitor set-up where we could watch other movies at the same time, as the president told us to "watch them all and learn from them."
\end{q}

\begin{trivia}
Coincidentally, the Japanese title of "Hard Times" was "The Street Fighter".
\end{trivia}


\section{Shapes and Sprites}
This historical detour was important in order to understand the sheet system. With this knowledge we can review the last GFX ROM requirements involving OBJs.  

On this layer, tiles can be used either directely or in groups which mandate distinct layout strategies.

\begin{figure}[H]
\img{ken_stage_design.png}
\caption*{Ken stage design phase. Inspiration, sketch, pixel art.\cite{sf2completefiles}.}
\end{figure}


\subsection{Sprite}
A sprite is a collection of tiles with rectangular boundaries. As we will see in the m68k programming section it can be rendered by issuing a single draw call mentioning the offset in the sheet, the width in tiles and the height in tiles.

 \begin{figure}[H]
\nbdraw{honda_alloc1}
\caption*{If Honda was a 10x6 tiles sprite, it would waste many tiles}
\end{figure}

It is inefficient for a set of tiles where many of them are transparent. Not only these take storage space in the GFXROM, they also count against the CPS-A/CPS-B limit of 256 tiles.

\pagebreak
\subsection{Shape}

A much more efficient way is to use a Shape where tiles location is arbitrary. It takes several draw calls to draw (tiles have to be specified one by one) but they can be located anywhere in a sheet.

Shapes have the double advantage to save storage space and narrow down tile count during rendition to the minimum. The example of Honda shows that only 41 tiles are required. It would have taken 60 tiles if a Sprite had been used.


 \begin{figure}[H]
\nbdraw{honda_alloc2}
\caption*{Honda as a shape.}
\end{figure}


To allow sprite draw calls, the build system must allocate images depending on the intended usage. All tiles in a sprite must be placed as they appeared in the original image.
 
% \begin{trivia}
Capcom games use almost exclusively shapes but the paper sheet system mandated to maintain some visual coherency so humans could keep tracks. Modern tools don't have this problem. 

The Honda shape on the sheet looks like mashed potatoes but using automatic allocation much more powerful system.

By looking at the sheet from later titles, it was inferred that Capcom abandoned the sheet system with the advent of the CPS-2. Likely using a fully computerized toochain devoid of paper and scissors, sheets have no spacial coherency, and they look like mashed potatoes.
% \end{trivia}

\begin{figure}[H]
\nbdraw{honda_sheet}
\caption*{A sheet with two version of Honda, Shape and Sprite}
\end{figure}

% On the contrary, a shape does not have to follow any constraint.




